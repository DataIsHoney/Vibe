<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöá Subway Math Express</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --subway-yellow: #FCCC0A;
            --subway-orange: #FF6319;
            --subway-blue: #0039A6;
            --subway-green: #6CBE45;
            --subway-red: #EE352E;
            --dark-bg: #0a0e1a;
            --card-bg: #141824;
            --card-hover: #1a1f2e;
        }

        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
            background: linear-gradient(135deg, #0a0e1a 0%, #1a1f2e 100%);
            background-attachment: fixed;
        }

        .subway-bg {
            background-image:
                repeating-linear-gradient(90deg, transparent, transparent 50px, rgba(255,255,255,0.03) 50px, rgba(255,255,255,0.03) 51px),
                repeating-linear-gradient(0deg, transparent, transparent 50px, rgba(255,255,255,0.03) 50px, rgba(255,255,255,0.03) 51px);
        }

        .card {
            background: linear-gradient(135deg, var(--card-bg) 0%, #1a1f2e 100%);
            border-radius: 1rem;
            border: 2px solid rgba(252, 204, 10, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease-in-out;
        }

        .card:hover {
            transform: translateY(-8px) scale(1.02);
            border-color: var(--subway-yellow);
            box-shadow: 0 12px 48px rgba(252, 204, 10, 0.3);
        }

        .btn {
            display: inline-block;
            font-weight: 700;
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
            user-select: none;
            border: 2px solid transparent;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--subway-yellow) 0%, var(--subway-orange) 100%);
            color: #000;
            border-color: var(--subway-yellow);
        }

        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 24px rgba(252, 204, 10, 0.4);
        }

        .btn-secondary {
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
            border-color: rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background-color: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .progress-bar-bg {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 9999px;
            height: 12px;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--subway-green) 0%, var(--subway-yellow) 100%);
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
            box-shadow: 0 0 20px rgba(108, 190, 69, 0.5);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .modal-content {
            background: linear-gradient(135deg, var(--card-bg) 0%, #1a1f2e 100%);
            border: 2px solid var(--subway-yellow);
            padding: 2.5rem;
            border-radius: 1rem;
            max-width: 90%;
            width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
        }

        .coin-float {
            animation: coinFloat 1s ease-out forwards;
        }

        @keyframes coinFloat {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(1.5); opacity: 0; }
        }

        .level-up {
            animation: levelUp 0.6s ease-out;
        }

        @keyframes levelUp {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .pulse-glow {
            animation: pulseGlow 2s infinite;
        }

        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(252, 204, 10, 0.3); }
            50% { box-shadow: 0 0 40px rgba(252, 204, 10, 0.6); }
        }

        .subway-line {
            display: inline-block;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            font-weight: 900;
            font-size: 14px;
            color: white;
            margin-right: 8px;
        }

        .express-train {
            animation: expressTrain 0.5s ease-in-out;
            background: linear-gradient(45deg, var(--subway-red), var(--subway-orange));
        }

        @keyframes expressTrain {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .coin-icon {
            display: inline-block;
            color: var(--subway-yellow);
            font-weight: 900;
            text-shadow: 0 0 10px rgba(252, 204, 10, 0.5);
        }
    </style>
</head>
<body class="text-white subway-bg">

    <div id="app" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Game Stats Header -->
        <header class="mb-8">
            <div class="text-center mb-6">
                <h1 class="text-5xl font-black sm:text-6xl bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500 bg-clip-text text-transparent">
                    üöá SUBWAY MATH EXPRESS
                </h1>
                <p class="mt-3 text-xl text-gray-300">Master Vedic Math ‚Ä¢ Earn Coins ‚Ä¢ Level Up!</p>
            </div>

            <!-- Stats Bar -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <!-- Coins -->
                <div class="card p-4 text-center">
                    <div class="text-3xl font-black coin-icon">üí∞ <span id="coin-count">0</span></div>
                    <div class="text-xs text-gray-400 mt-1">COINS</div>
                </div>

                <!-- Level & Station -->
                <div class="card p-4 text-center">
                    <div class="text-2xl font-bold">
                        <span class="subway-line" style="background-color: var(--subway-yellow); color: #000;" id="level-badge">1</span>
                        <span id="station-name" class="text-white">1st St</span>
                    </div>
                    <div class="text-xs text-gray-400 mt-1">STATION LEVEL</div>
                </div>

                <!-- XP Progress -->
                <div class="card p-4">
                    <div class="text-xs text-gray-400 mb-2">XP TO NEXT STATION</div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar" id="xp-bar" style="width: 0%"></div>
                    </div>
                    <div class="text-xs text-gray-300 mt-1 text-center"><span id="xp-current">0</span>/<span id="xp-needed">100</span></div>
                </div>

                <!-- Express Train Status -->
                <div class="card p-4 text-center" id="express-card">
                    <div class="text-2xl font-bold">üöÑ <span id="multiplier">1x</span></div>
                    <div class="text-xs text-gray-400 mt-1" id="express-status">PLAY 3 MIN FOR EXPRESS!</div>
                </div>
            </div>

            <div id="user-info" class="text-center text-sm text-gray-500"></div>
        </header>

        <!-- Main View: Category/Shortcut Selection -->
        <main id="main-view">
            <div id="main-view-controls" class="flex justify-center mb-6 space-x-4">
                 <button id="review-btn" class="btn btn-primary text-lg px-8 py-3">Start Review Session</button>
                 <button id="back-to-categories-btn" class="btn btn-secondary text-lg px-8 py-3 hidden">&larr; Back to Categories</button>
            </div>
           
            <div id="category-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Category cards will be injected here -->
            </div>
            <div id="shortcut-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
                <!-- Shortcut cards will be injected here -->
            </div>
        </main>

        <!-- Learn View: Shortcut Explanation & Examples -->
        <section id="learn-view" class="hidden">
            <div class="card p-8 max-w-4xl mx-auto">
                <button id="back-to-main-btn" class="btn btn-secondary mb-6">‚¨ÖÔ∏è Back to Station</button>
                <h2 id="learn-title" class="text-4xl font-black text-yellow-400 mb-4"></h2>
                <p id="learn-explanation" class="text-xl text-gray-300 mb-8 leading-relaxed"></p>
                <h3 class="text-2xl font-bold text-white mb-4">üìù Examples</h3>
                <div id="learn-examples" class="space-y-3 text-lg"></div>
                <div class="text-center mt-8">
                    <button id="start-quiz-btn" class="btn btn-primary px-12 py-4 text-xl">üöÄ START QUIZ!</button>
                </div>
            </div>
        </section>

        <!-- Quiz View -->
        <section id="quiz-view" class="hidden">
             <div class="card p-8 max-w-2xl mx-auto relative">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="quiz-title" class="text-2xl font-bold text-white">Quiz Time!</h2>
                    <div id="quiz-progress" class="text-lg font-medium text-gray-300"></div>
                </div>
                <div class="mb-6">
                    <div class="text-6xl font-black text-center text-yellow-400 py-8" id="quiz-question"></div>
                </div>
                <div class="flex flex-col items-center relative" id="answer-container">
                    <input type="number" id="quiz-answer" class="text-center text-3xl p-4 border-2 border-yellow-400 rounded-lg w-full max-w-xs bg-gray-900 text-white focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500" placeholder="?">
                    <button id="submit-answer-btn" class="btn btn-primary mt-4 w-full max-w-xs text-lg">Submit Answer</button>
                    <p id="feedback" class="mt-4 h-8 text-xl font-bold"></p>
                    <!-- Coin animation container -->
                    <div id="coin-animation-container" class="absolute top-0 left-1/2 transform -translate-x-1/2"></div>
                </div>
             </div>
        </section>

    </div>

    <!-- Quiz Results Modal -->
    <div id="results-modal" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <h2 class="text-4xl font-black text-yellow-400 mb-4">üéâ STATION COMPLETE! üéâ</h2>
            <p class="text-6xl font-extrabold mb-4 text-white" id="results-score"></p>
            <div class="text-3xl font-bold mb-4 coin-icon">
                üí∞ +<span id="coins-earned">0</span> COINS
            </div>
            <div class="text-xl font-bold mb-6 text-green-400">
                +<span id="xp-earned">0</span> XP
            </div>
            <p class="text-lg text-gray-300 mb-6" id="results-message"></p>
            <button id="close-results-btn" class="btn btn-primary">Continue Journey</button>
        </div>
    </div>

    <!-- Express Train Bonus Modal -->
    <div id="express-modal" class="modal-overlay hidden">
        <div class="modal-content text-center express-train">
            <h2 class="text-5xl font-black text-white mb-4">üöÑ EXPRESS TRAIN ACTIVATED! üöÑ</h2>
            <p class="text-3xl font-bold text-yellow-300 mb-6">2x COIN MULTIPLIER!</p>
            <p class="text-xl text-white mb-6">You've been grinding for 3 minutes! All coins are now DOUBLED!</p>
            <button id="close-express-btn" class="btn btn-primary">LET'S GO!</button>
        </div>
    </div>

    <!-- Level Up Modal -->
    <div id="levelup-modal" class="modal-overlay hidden">
        <div class="modal-content text-center level-up">
            <h2 class="text-5xl font-black text-yellow-400 mb-4">üéä LEVEL UP! üéä</h2>
            <p class="text-4xl font-bold text-white mb-6">
                <span class="subway-line" style="background-color: var(--subway-yellow); color: #000;" id="new-level-badge">2</span>
                <span id="new-station-name">14th St</span>
            </p>
            <p class="text-2xl text-gray-300 mb-6">New station unlocked!</p>
            <div class="text-3xl font-bold mb-6 coin-icon">
                üí∞ +<span id="levelup-bonus">50</span> BONUS COINS
            </div>
            <button id="close-levelup-btn" class="btn btn-primary">Continue</button>
        </div>
    </div>


    <script type="module">
        // Firebase Imports (Commented Out)
        // import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIG (Commented Out) ---
        /*
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { 
            apiKey: "YOUR_API_KEY", 
            authDomain: "YOUR_AUTH_DOMAIN", 
            projectId: "YOUR_PROJECT_ID" 
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- FIREBASE INITIALIZATION (Commented Out) ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        */

        // --- GLOBAL STATE & DOM ELEMENTS ---
        // let userId = null;
        let userProgress = {};
        let currentCategory = null;
        let currentShortcut = null;
        let quizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;

        // GAME MECHANICS
        let gameStats = {
            coins: 0,
            xp: 0,
            level: 1,
            multiplier: 1,
            startTime: Date.now(),
            expressUnlocked: false
        };

        const SUBWAY_STATIONS = [
            '1st St', '14th St', '23rd St', '34th St', '42nd St',
            '59th St', '72nd St', '86th St', '96th St', '125th St',
            'Bronx', 'Queens', 'Brooklyn', 'Manhattan', 'Express Hub'
        ];

        const XP_PER_LEVEL = [100, 150, 200, 300, 400, 500, 700, 900, 1200, 1500, 2000, 2500, 3000, 4000, 5000];
        const COINS_PER_CORRECT = 10;
        const XP_PER_CORRECT = 15;
        const EXPRESS_TIME = 180000; // 3 minutes in milliseconds

        const mainView = document.getElementById('main-view');
        const learnView = document.getElementById('learn-view');
        const quizView = document.getElementById('quiz-view');
        const categoryGrid = document.getElementById('category-grid');
        const shortcutGrid = document.getElementById('shortcut-grid');
        const reviewBtn = document.getElementById('review-btn');
        const backToCategoriesBtn = document.getElementById('back-to-categories-btn');
        const userInfo = document.getElementById('user-info');
        
        // --- MATH SHORTCUTS DATA ---
        const allShortcuts = {
            addition: {
                title: 'Addition Tips',
                shortcuts: {
                    add9: {
                        title: 'Adding 9',
                        explanation: 'To add 9, add 10 first and then subtract 1. For 67+9: think 67+10=77, then 77-1=76.',
                        generateQuestion: () => {
                            const n = Math.floor(Math.random() * 90) + 10;
                            return { question: `${n} + 9`, answer: n + 9 };
                        }
                    },
                    nearDoubles: {
                        title: 'Near Doubles',
                        explanation: 'If numbers are consecutive (like 47+48), double the smaller and add 1. For 47+48: think 47√ó2=94, then 94+1=95.',
                        generateQuestion: () => {
                            const n = Math.floor(Math.random() * 30) + 10;
                            return { question: `${n} + ${n+1}`, answer: n * 2 + 1 };
                        }
                    },
                    addInChunks: {
                        title: 'Left-to-Right Addition',
                        explanation: 'Add from left to right (Vedic style). For 47+38: add tens (40+30=70), then ones (7+8=15), then combine (70+15=85).',
                        generateQuestion: () => {
                            const t1 = (Math.floor(Math.random()*5)+2)*10;
                            const o1 = Math.floor(Math.random()*9)+1;
                            const t2 = (Math.floor(Math.random()*5)+2)*10;
                            const o2 = Math.floor(Math.random()*9)+1;
                            return { question: `${t1+o1} + ${t2+o2}`, answer: t1+o1+t2+o2 };
                        }
                    },
                    complement100: {
                        title: 'Complement to 100',
                        explanation: 'To add numbers near 100, use complements. For 97+88: take 97 to 100 (+3), then add remaining 85. Result: 100+85=185.',
                        generateQuestion: () => {
                            const n1 = Math.floor(Math.random() * 9) + 91; // 91-99
                            const n2 = Math.floor(Math.random() * 20) + 80; // 80-99
                            return { question: `${n1} + ${n2}`, answer: n1 + n2 };
                        }
                    },
                    addNear100: {
                        title: 'Adding Near Powers of 10',
                        explanation: 'For numbers near 100/1000, add the round number then adjust. For 156+99: think 156+100=256, then 256-1=255.',
                        generateQuestion: () => {
                            const n = Math.floor(Math.random() * 200) + 100;
                            const near = [99, 98, 999, 1001][Math.floor(Math.random()*4)];
                            return { question: `${n} + ${near}`, answer: n + near };
                        }
                    },
                }
            },
            subtraction: {
                title: 'Subtraction Tips',
                shortcuts: {
                    sub9: {
                        title: 'Subtracting 9',
                        explanation: 'To subtract 9, subtract 10 first then add 1 back. For 84-9: think 84-10=74, then 74+1=75.',
                        generateQuestion: () => {
                            const n = Math.floor(Math.random() * 90) + 20;
                            return { question: `${n} - 9`, answer: n - 9 };
                        }
                    },
                    nikhilam: {
                        title: 'Nikhilam (All from 9, Last from 10)',
                        explanation: 'For 1000-347: subtract each digit from 9 except the last from 10. (9-3=6, 9-4=5, 10-7=3). Answer: 653.',
                        generateQuestion: () => {
                            const n = Math.floor(Math.random() * 899) + 100;
                            return { question: `1000 - ${n}`, answer: 1000 - n };
                        }
                    },
                    constantDiff: {
                        title: 'Keep the Difference (Equidistance)',
                        explanation: 'Add or subtract the same amount from both numbers. For 63-47: add 3 to both ‚Üí 66-50=16.',
                        generateQuestion: () => {
                            const n2 = Math.floor(Math.random() * 40) + 40;
                            const n1 = n2 + Math.floor(Math.random()*25)+10;
                            return { question: `${n1} - ${n2}`, answer: n1-n2};
                        }
                    },
                    complementSub: {
                        title: 'Complement Subtraction',
                        explanation: 'For 150-87, find complement of 87 to 100 (which is 13), then add to 50. Result: 50+13=63.',
                        generateQuestion: () => {
                            const hundreds = Math.floor(Math.random() * 3) + 2;
                            const n1 = hundreds * 100 + Math.floor(Math.random() * 50);
                            const n2 = (hundreds-1) * 100 + Math.floor(Math.random() * 50) + 50;
                            return { question: `${n1} - ${n2}`, answer: n1 - n2 };
                        }
                    },
                    leftToRightSub: {
                        title: 'Left-to-Right Subtraction',
                        explanation: 'Subtract from left to right. For 156-82: first 100-80=20, then 56-2=54, then 20+54=74.',
                        generateQuestion: () => {
                            const n1 = Math.floor(Math.random() * 100) + 100;
                            const n2 = Math.floor(Math.random() * 50) + 30;
                            return { question: `${n1} - ${n2}`, answer: n1 - n2 };
                        }
                    },
                }
            },
            multiplication: {
                title: 'Multiplication Tips',
                shortcuts: {
                    squareEnding5: {
                        title: 'Squaring Numbers Ending in 5',
                        explanation: 'For 35¬≤: multiply first digit by next number (3√ó4=12), then append 25. Answer: 1225. For 85¬≤: 8√ó9=72, append 25 = 7225.',
                        generateQuestion: () => {
                            const n = Math.floor(Math.random() * 9) + 1;
                            const num = n * 10 + 5;
                            return { question: `${num}¬≤`, answer: num * num };
                        }
                    },
                    nikhilamMult: {
                        title: 'Nikhilam Multiplication (Near 100)',
                        explanation: 'For 97√ó96: both are near 100. Deficiencies: -3, -4. Cross-subtract: 97-4=93 (or 96-3). Multiply deficiencies: 3√ó4=12. Answer: 9312.',
                        generateQuestion: () => {
                            const n1 = Math.floor(Math.random() * 9) + 91;
                            const n2 = Math.floor(Math.random() * 9) + 91;
                            return { question: `${n1} √ó ${n2}`, answer: n1 * n2 };
                        }
                    },
                    verticalCrosswise: {
                        title: 'Vertically & Crosswise (2-Digit)',
                        explanation: 'For 23√ó14: Vertically (2√ó1=2, 3√ó4=12), Crosswise (2√ó4+3√ó1=11), combine: 2|11|12 = 2+1|1+1|2 = 322.',
                        generateQuestion: () => {
                            const n1 = Math.floor(Math.random() * 30) + 11;
                            const n2 = Math.floor(Math.random() * 30) + 11;
                            return { question: `${n1} √ó ${n2}`, answer: n1 * n2 };
                        }
                    },
                    mult11adv: {
                        title: 'Multiply by 11',
                        explanation: 'For 47√ó11: add digits (4+7=11), put sum in middle handling carry: 4|11|7 = 517. For 63√ó11: 6|9|3 = 693.',
                        generateQuestion: () => {
                            const tens = Math.floor(Math.random() * 8) + 1;
                            const ones = Math.floor(Math.random() * 9) + 1;
                            const num = tens * 10 + ones;
                            return { question: `${num} √ó 11`, answer: num * 11 };
                        }
                    },
                    mult12: {
                        title: 'Multiply by 12',
                        explanation: 'To multiply by 12, multiply by 10, then add the number doubled. For 34√ó12: 340 + 68 = 408.',
                        generateQuestion: () => {
                            const n = Math.floor(Math.random() * 30) + 10;
                            return { question: `${n} √ó 12`, answer: n * 12 };
                        }
                    },
                    multBy25: {
                        title: 'Multiply by 25',
                        explanation: 'For 36√ó25: divide by 4 (36√∑4=9), then multiply by 100. Answer: 900. Works best with multiples of 4.',
                        generateQuestion: () => {
                            const n = (Math.floor(Math.random()*15)+2)*4;
                            return { question: `${n} √ó 25`, answer: n * 25 };
                        }
                    },
                    baseMult: {
                        title: 'Base Method Multiplication',
                        explanation: 'For 43√ó48 (near 50): Excesses: +3, -2. Cross-add: 43-2=41, append product: 3√ó-2=-6 (borrow). Answer: 40|56 = 2064.',
                        generateQuestion: () => {
                            const n1 = Math.floor(Math.random() * 15) + 40;
                            const n2 = Math.floor(Math.random() * 15) + 40;
                            return { question: `${n1} √ó ${n2}`, answer: n1 * n2 };
                        }
                    },
                    squareNear50: {
                        title: 'Squaring Near 50',
                        explanation: 'For 53¬≤: excess is 3. Left: 25+3=28, Right: 3¬≤=09. Answer: 2809. For 47¬≤: deficit -3, Left: 25-3=22, Right: 3¬≤=09 = 2209.',
                        generateQuestion: () => {
                            const excess = Math.floor(Math.random() * 10) - 5;
                            const num = 50 + excess;
                            return { question: `${num}¬≤`, answer: num * num };
                        }
                    },
                }
            },
            division: {
                title: 'Division Tips',
                shortcuts: {
                    divBy5: {
                        title: 'Divide by 5',
                        explanation: 'To divide by 5, multiply by 2 and divide by 10. For 340√∑5: 340√ó2=680, then 680√∑10=68.',
                        generateQuestion: () => {
                            const n = (Math.floor(Math.random()*40)+10)*5;
                            return { question: `${n} √∑ 5`, answer: n / 5 };
                        }
                    },
                    divBy9: {
                        title: 'Division by 9 (Digit Sum)',
                        explanation: 'For 234√∑9: sum digits (2+3+4=9), divisible! To find quotient, use pattern: 234‚âà9√ó26. Check: 9√ó26=234.',
                        generateQuestion: () => {
                            const ans = Math.floor(Math.random()*30)+10;
                            const n = ans * 9;
                            return { question: `${n} √∑ 9`, answer: ans };
                        }
                    },
                    ekadhikena: {
                        title: 'Ekadhikena (One More Than Previous)',
                        explanation: 'For 1√∑19: divisor 19, one more than previous digit: 1+1=2. Pattern: 0.052631... For simple cases like 4√∑19‚âà0.21.',
                        generateQuestion: () => {
                            const quotient = Math.floor(Math.random()*9)+1;
                            const n = quotient * 19;
                            return { question: `${n} √∑ 19`, answer: quotient };
                        }
                    },
                    divBy4: {
                        title: 'Divide by 4',
                        explanation: 'Halve the number twice. For 144√∑4: first 144√∑2=72, then 72√∑2=36.',
                        generateQuestion: () => {
                            const n = (Math.floor(Math.random()*30)+5)*4;
                            return { question: `${n} √∑ 4`, answer: n / 4 };
                        }
                    },
                    divBy8: {
                        title: 'Divide by 8',
                        explanation: 'Halve the number three times. For 128√∑8: 128√∑2=64, 64√∑2=32, 32√∑2=16.',
                        generateQuestion: () => {
                            const n = (Math.floor(Math.random()*20)+5)*8;
                            return { question: `${n} √∑ 8`, answer: n / 8 };
                        }
                    },
                    divBy11: {
                        title: 'Divisibility by 11',
                        explanation: 'Alternating sum of digits must be divisible by 11. For 121: 1-2+1=0 (divisible). For 253: 2-5+3=0 (yes!).',
                        generateQuestion: () => {
                            const ans = Math.floor(Math.random()*20)+5;
                            const n = ans * 11;
                            return { question: `${n} √∑ 11`, answer: ans };
                        }
                    },
                    paravartya: {
                        title: 'Paravartya (Transpose & Adjust)',
                        explanation: 'For division by numbers with last digit 9, use complement. 1√∑19: use 2 (20-19+1). Advanced technique for complex divisions.',
                        generateQuestion: () => {
                            const divisor = [29, 39, 49, 19][Math.floor(Math.random()*4)];
                            const quotient = Math.floor(Math.random()*5)+2;
                            const n = quotient * divisor;
                            return { question: `${n} √∑ ${divisor}`, answer: quotient };
                        }
                    },
                    ruleFor3: {
                        title: 'Divisibility by 3',
                        explanation: 'Sum all digits. If sum is divisible by 3, so is the number. For 147: 1+4+7=12, 12√∑3=4, so 147√∑3 works!',
                        generateQuestion: () => {
                            const ans = Math.floor(Math.random()*50)+10;
                            const n = ans * 3;
                            return { question: `${n} √∑ 3`, answer: ans };
                        }
                    },
                }
            }
        };
        
        // --- FIREBASE AUTHENTICATION & DATA HANDLING (Commented Out) ---
        /*
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userInfo.textContent = `User ID: ${userId}`;
                await setupUserListener();
            }
        });
        
        async function authenticateUser() {
            try {
                // Defaulting to Anonymous Sign-in as requested.
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Authentication failed:", error);
                userInfo.innerHTML = `<span class="text-red-600 font-semibold">Could not save progress.</span> Please ensure Anonymous Sign-in is enabled in your Firebase project's settings.`;
            }
        }
        
        async function setupUserListener() {
            if (!userId) return;
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/mathShortcutsProgress/data`);
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    userProgress = docSnap.data();
                } else {
                    // Initialize progress for new nested structure
                    userProgress = {};
                    for (const catKey in allShortcuts) {
                        userProgress[catKey] = {};
                        for (const shortKey in allShortcuts[catKey].shortcuts) {
                            userProgress[catKey][shortKey] = { strength: 0, lastReviewed: null };
                        }
                    }
                    saveProgress();
                }
                renderCategories();
            }, (error) => {
                console.error("Error listening to progress:", error);
            });
        }
        
        async function saveProgress() {
            if (!userId) return;
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/mathShortcutsProgress/data`);
            try {
                await setDoc(docRef, userProgress);
            } catch (error) {
                console.error("Error saving progress: ", error);
            }
        }
        */

        // --- LOCAL STORAGE HANDLING ---
        const STORAGE_KEY = 'subwayMathExpress_progress';
        const STATS_KEY = 'subwayMathExpress_stats';

        function initializeLocalProgress() {
            // Try to load from localStorage first
            const savedProgress = localStorage.getItem(STORAGE_KEY);
            const savedStats = localStorage.getItem(STATS_KEY);

            if (savedProgress) {
                // Load existing progress
                try {
                    userProgress = JSON.parse(savedProgress);
                    console.log("‚úÖ Progress loaded from localStorage");
                } catch (e) {
                    console.error("Error loading progress:", e);
                    createEmptyProgress();
                }
            } else {
                createEmptyProgress();
            }

            if (savedStats) {
                // Load existing game stats
                try {
                    const loaded = JSON.parse(savedStats);
                    gameStats.coins = loaded.coins || 0;
                    gameStats.xp = loaded.xp || 0;
                    gameStats.level = loaded.level || 1;
                    gameStats.multiplier = loaded.multiplier || 1;
                    gameStats.expressUnlocked = loaded.expressUnlocked || false;
                    console.log("‚úÖ Game stats loaded from localStorage");
                } catch (e) {
                    console.error("Error loading stats:", e);
                }
            }

            // Reset start time (don't save this)
            gameStats.startTime = Date.now();

            // Update UI with controls
            const hasProgress = savedProgress || savedStats;
            const welcomeMsg = hasProgress
                ? `<span class="text-green-400">üíæ Progress auto-saved!</span>`
                : `<span class="text-yellow-400">üéÆ New game started!</span>`;

            userInfo.innerHTML = `
                ${welcomeMsg}
                <button onclick="exportProgress()" class="ml-3 text-blue-400 hover:text-blue-300 underline">üì§ Export</button>
                <button onclick="importProgress()" class="ml-3 text-green-400 hover:text-green-300 underline">üì• Import</button>
                <button onclick="resetProgress()" class="ml-3 text-red-400 hover:text-red-300 underline">üóëÔ∏è Reset</button>
            `;
            renderCategories();
            updateGameStats();
        }

        function createEmptyProgress() {
            userProgress = {};
            for (const catKey in allShortcuts) {
                userProgress[catKey] = {};
                for (const shortKey in allShortcuts[catKey].shortcuts) {
                    userProgress[catKey][shortKey] = { strength: 0, lastReviewed: null };
                }
            }
        }

        function saveProgress() {
            try {
                // Save user progress (mastery levels)
                localStorage.setItem(STORAGE_KEY, JSON.stringify(userProgress));

                // Save game stats (coins, xp, level)
                const statsToSave = {
                    coins: gameStats.coins,
                    xp: gameStats.xp,
                    level: gameStats.level,
                    multiplier: gameStats.multiplier,
                    expressUnlocked: gameStats.expressUnlocked
                };
                localStorage.setItem(STATS_KEY, JSON.stringify(statsToSave));

                console.log("üíæ Progress saved to localStorage");
            } catch (e) {
                console.error("Error saving progress:", e);
                userInfo.innerHTML = `<span class="text-red-400">‚ö†Ô∏è Could not save progress (storage full?)</span>`;
            }
        }

        // Reset all progress
        function resetProgress() {
            if (confirm("üö® Are you sure? This will delete ALL your coins, XP, and progress!")) {
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem(STATS_KEY);
                location.reload(); // Reload page to reset everything
            }
        }

        // Export progress to file
        function exportProgress() {
            try {
                const exportData = {
                    version: 1,
                    timestamp: new Date().toISOString(),
                    progress: userProgress,
                    stats: {
                        coins: gameStats.coins,
                        xp: gameStats.xp,
                        level: gameStats.level,
                        multiplier: gameStats.multiplier,
                        expressUnlocked: gameStats.expressUnlocked
                    }
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `subway-math-backup-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);

                alert("‚úÖ Progress exported! Save this file to backup your progress.");
            } catch (e) {
                console.error("Export error:", e);
                alert("‚ùå Failed to export progress.");
            }
        }

        // Import progress from file
        function importProgress() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importData = JSON.parse(event.target.result);

                        // Validate data structure
                        if (!importData.progress || !importData.stats) {
                            throw new Error("Invalid backup file format");
                        }

                        // Confirm before overwriting
                        if (confirm("‚ö†Ô∏è This will overwrite your current progress. Continue?")) {
                            // Save imported data
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(importData.progress));
                            localStorage.setItem(STATS_KEY, JSON.stringify(importData.stats));

                            alert("‚úÖ Progress imported successfully! Reloading...");
                            location.reload();
                        }
                    } catch (e) {
                        console.error("Import error:", e);
                        alert("‚ùå Failed to import: Invalid file format.");
                    }
                };
                reader.readAsText(file);
            };

            input.click();
        }

        // Make functions available globally
        window.resetProgress = resetProgress;
        window.exportProgress = exportProgress;
        window.importProgress = importProgress;

        // --- GAME MECHANICS FUNCTIONS ---
        function updateGameStats() {
            document.getElementById('coin-count').textContent = gameStats.coins;
            document.getElementById('level-badge').textContent = gameStats.level;
            document.getElementById('station-name').textContent = SUBWAY_STATIONS[gameStats.level - 1] || 'Final Stop';
            document.getElementById('multiplier').textContent = gameStats.multiplier + 'x';

            const xpNeeded = XP_PER_LEVEL[gameStats.level - 1] || 5000;
            const xpProgress = (gameStats.xp / xpNeeded) * 100;
            document.getElementById('xp-bar').style.width = Math.min(xpProgress, 100) + '%';
            document.getElementById('xp-current').textContent = gameStats.xp;
            document.getElementById('xp-needed').textContent = xpNeeded;

            // Check for express train
            checkExpressTrain();
        }

        function awardCoins(amount) {
            const coins = amount * gameStats.multiplier;
            gameStats.coins += coins;
            updateGameStats();
            showCoinAnimation(coins);
            saveProgress(); // Auto-save
            return coins;
        }

        function awardXP(amount) {
            gameStats.xp += amount;
            const xpNeeded = XP_PER_LEVEL[gameStats.level - 1] || 5000;

            if (gameStats.xp >= xpNeeded) {
                gameStats.xp -= xpNeeded;
                levelUp();
            }
            updateGameStats();
            saveProgress(); // Auto-save
        }

        function showCoinAnimation(amount) {
            const container = document.getElementById('coin-animation-container');
            const coinEl = document.createElement('div');
            coinEl.className = 'coin-float text-4xl font-bold coin-icon absolute';
            coinEl.textContent = '+' + amount + ' üí∞';
            container.appendChild(coinEl);

            setTimeout(() => {
                container.removeChild(coinEl);
            }, 1000);
        }

        function levelUp() {
            gameStats.level++;
            const bonus = gameStats.level * 50;
            gameStats.coins += bonus;

            document.getElementById('new-level-badge').textContent = gameStats.level;
            document.getElementById('new-station-name').textContent = SUBWAY_STATIONS[gameStats.level - 1] || 'Final Stop';
            document.getElementById('levelup-bonus').textContent = bonus;

            // Show level up modal
            document.getElementById('levelup-modal').classList.remove('hidden');
            saveProgress(); // Auto-save
        }

        function checkExpressTrain() {
            const elapsed = Date.now() - gameStats.startTime;
            if (!gameStats.expressUnlocked && elapsed >= EXPRESS_TIME) {
                gameStats.expressUnlocked = true;
                gameStats.multiplier = 2;
                document.getElementById('express-modal').classList.remove('hidden');
                document.getElementById('express-status').textContent = '2x MULTIPLIER ACTIVE!';
                document.getElementById('express-card').classList.add('pulse-glow');
                saveProgress(); // Auto-save
            } else if (!gameStats.expressUnlocked) {
                const remaining = Math.ceil((EXPRESS_TIME - elapsed) / 1000);
                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;
                document.getElementById('express-status').textContent = `${minutes}:${seconds.toString().padStart(2, '0')} TO EXPRESS`;
            }
        }

        // Update express timer every second
        setInterval(checkExpressTrain, 1000);
        
        // --- VIEW RENDERING & SWITCHING ---
        function switchView(view) {
            mainView.classList.add('hidden');
            learnView.classList.add('hidden');
            quizView.classList.add('hidden');
            document.getElementById(view).classList.remove('hidden');
        }

        function renderCategories() {
            currentCategory = null;
            categoryGrid.innerHTML = '';
            categoryGrid.classList.remove('hidden');
            shortcutGrid.classList.add('hidden');
            backToCategoriesBtn.classList.add('hidden');
            reviewBtn.classList.remove('hidden');

            const colors = ['var(--subway-yellow)', 'var(--subway-orange)', 'var(--subway-blue)', 'var(--subway-green)'];
            const lines = ['üü®', 'üüß', 'üü¶', 'üü©'];

            Object.entries(allShortcuts).forEach(([key, category], index) => {
                const card = document.createElement('div');
                card.className = 'card p-8 cursor-pointer text-center';
                card.dataset.category = key;
                card.innerHTML = `
                    <div class="subway-line mb-4" style="background-color: ${colors[index]}; color: #000; width: 48px; height: 48px; line-height: 48px; font-size: 24px; margin: 0 auto;">
                        ${lines[index]}
                    </div>
                    <h2 class="text-3xl font-bold text-white">${category.title}</h2>
                `;
                card.addEventListener('click', () => renderShortcutGrid(key));
                categoryGrid.appendChild(card);
            });
        }

        function renderShortcutGrid(categoryKey) {
            currentCategory = categoryKey;
            shortcutGrid.innerHTML = '';
            categoryGrid.classList.add('hidden');
            shortcutGrid.classList.remove('hidden');
            backToCategoriesBtn.classList.remove('hidden');
            reviewBtn.classList.add('hidden');

            const category = allShortcuts[categoryKey];
            Object.entries(category.shortcuts).forEach(([key, shortcut]) => {
                const progress = userProgress[categoryKey]?.[key] || { strength: 0 };
                const strength = progress.strength || 0;
                const card = document.createElement('div');
                card.className = 'card p-6 cursor-pointer';
                card.dataset.shortcut = key;
                card.innerHTML = `
                    <h3 class="text-xl font-bold text-white mb-3">${shortcut.title}</h3>
                    <div class="progress-bar-bg w-full mb-2">
                        <div class="progress-bar" style="width: ${strength * 20}%"></div>
                    </div>
                    <span class="text-sm text-gray-400 mt-1 block">Mastery: ${strength}/5</span>
                `;
                card.addEventListener('click', () => showLearnView(categoryKey, key));
                shortcutGrid.appendChild(card);
            });
        }

        function showLearnView(categoryKey, shortcutKey) {
            currentCategory = categoryKey;
            currentShortcut = shortcutKey;
            const shortcut = allShortcuts[categoryKey].shortcuts[shortcutKey];
            document.getElementById('learn-title').textContent = shortcut.title;
            document.getElementById('learn-explanation').textContent = shortcut.explanation;

            const examplesContainer = document.getElementById('learn-examples');
            examplesContainer.innerHTML = ''; // Clear previous examples

            // Generate 5 examples
            for (let i = 0; i < 5; i++) {
                const ex = shortcut.generateQuestion();
                examplesContainer.innerHTML += `<div class="bg-gray-800 border border-yellow-400/30 p-4 rounded-md">
                    <span class="font-semibold text-white text-lg">${ex.question}</span> = <span class="text-yellow-400 font-black text-lg">${ex.answer}</span>
                </div>`;
            }

            switchView('learn-view');
        }


        // --- QUIZ LOGIC ---
        function startQuiz(categoryKey, shortcutKey) {
            currentCategory = categoryKey;
            currentShortcut = shortcutKey;
            currentQuestionIndex = 0;
            score = 0;
            quizQuestions = [];
            const shortcut = allShortcuts[categoryKey].shortcuts[shortcutKey];
            for (let i = 0; i < 10; i++) {
                quizQuestions.push(shortcut.generateQuestion());
            }
            document.getElementById('quiz-title').textContent = `${shortcut.title} Quiz`;
            switchView('quiz-view');
            displayNextQuestion();
        }

        function displayNextQuestion() {
            if (currentQuestionIndex >= quizQuestions.length) {
                endQuiz();
                return;
            }

            const q = quizQuestions[currentQuestionIndex];
            document.getElementById('quiz-progress').textContent = `Question ${currentQuestionIndex + 1}/10`;
            document.getElementById('quiz-question').textContent = q.question;
            const answerInput = document.getElementById('quiz-answer');
            answerInput.value = '';
            answerInput.focus();
            document.getElementById('feedback').textContent = '';
        }
        
        function handleSubmitAnswer() {
            if (currentQuestionIndex >= quizQuestions.length) return; // FIX: Prevent running after quiz ends
            const feedbackEl = document.getElementById('feedback');
            const userAnswer = parseInt(document.getElementById('quiz-answer').value, 10);
            const correctAnswer = quizQuestions[currentQuestionIndex].answer;

            if (isNaN(userAnswer)) {
                feedbackEl.textContent = "‚ö†Ô∏è Please enter a number.";
                feedbackEl.className = "mt-4 h-8 text-xl font-bold text-yellow-400";
                return;
            }

            if (userAnswer === correctAnswer) {
                score++;
                const coinsEarned = awardCoins(COINS_PER_CORRECT);
                awardXP(XP_PER_CORRECT);
                feedbackEl.textContent = `‚úÖ CORRECT! +${coinsEarned} üí∞`;
                feedbackEl.className = "mt-4 h-8 text-xl font-bold text-green-400";
            } else {
                feedbackEl.textContent = `‚ùå Wrong! Answer: ${correctAnswer}`;
                feedbackEl.className = "mt-4 h-8 text-xl font-bold text-red-400";
            }

            currentQuestionIndex++;
            setTimeout(displayNextQuestion, 1200);
        }

        function endQuiz() {
            const progress = userProgress[currentCategory][currentShortcut];

            if (score >= 8) {
                progress.strength = Math.min(5, progress.strength + 1);
            } else if (score < 5 && progress.strength > 0) {
                 progress.strength = Math.max(0, progress.strength - 1);
            }
            progress.lastReviewed = new Date().toISOString();

            // Calculate bonuses
            const bonusCoins = score * 5 * gameStats.multiplier;
            const bonusXP = score * 10;

            gameStats.coins += bonusCoins;
            gameStats.xp += bonusXP;

            const xpNeeded = XP_PER_LEVEL[gameStats.level - 1] || 5000;
            if (gameStats.xp >= xpNeeded) {
                gameStats.xp -= xpNeeded;
                levelUp();
            }

            saveProgress();
            showResultsModal(bonusCoins, bonusXP);
        }

        // --- SPACED REPETITION ---
        function startReviewSession() {
            let nextShortcut = null;
            let minStrength = 6;
            let oldestDate = new Date().toISOString();

            for (const catKey in userProgress) {
                for (const shortKey in userProgress[catKey]) {
                    const progress = userProgress[catKey][shortKey];
                    if (progress.strength >= 5) continue;

                    if (progress.strength < minStrength) {
                        minStrength = progress.strength;
                        oldestDate = progress.lastReviewed || '1970-01-01T00:00:00.000Z';
                        nextShortcut = { category: catKey, shortcut: shortKey };
                    } else if (progress.strength === minStrength) {
                        const currentLastReviewed = progress.lastReviewed || '1970-01-01T00:00:00.000Z';
                        if (currentLastReviewed < oldestDate) {
                            oldestDate = currentLastReviewed;
                            nextShortcut = { category: catKey, shortcut: shortKey };
                        }
                    }
                }
            }
            
            if (!nextShortcut) { // If all are mastered, pick a random one
                const categories = Object.keys(allShortcuts);
                const randomCategory = categories[Math.floor(Math.random() * categories.length)];
                const shortcuts = Object.keys(allShortcuts[randomCategory].shortcuts);
                const randomShortcut = shortcuts[Math.floor(Math.random() * shortcuts.length)];
                nextShortcut = { category: randomCategory, shortcut: randomShortcut };
            }

            showLearnView(nextShortcut.category, nextShortcut.shortcut);
        }
        
        // --- MODAL & UI ---
        function showResultsModal(bonusCoins, bonusXP) {
            const modal = document.getElementById('results-modal');
            document.getElementById('results-score').textContent = `${score} / 10`;
            document.getElementById('coins-earned').textContent = bonusCoins;
            document.getElementById('xp-earned').textContent = bonusXP;

            let message = "Keep pushing! üöá";
            if (score >= 8) message = "Great work! You're on track! üî•";
            if (score === 10) message = "PERFECT! You're a math legend! üèÜ";
            document.getElementById('results-message').textContent = message;
            modal.classList.remove('hidden');
            updateGameStats();
        }

        function closeResultsModal() {
            document.getElementById('results-modal').classList.add('hidden');
            switchView('main-view');
            // If we were in a category, go back to that category grid
            if(currentCategory) {
                renderShortcutGrid(currentCategory);
            } else {
                renderCategories();
            }
        }
        
        // --- EVENT LISTENERS ---
        backToCategoriesBtn.addEventListener('click', renderCategories);
        document.getElementById('back-to-main-btn').addEventListener('click', () => {
             switchView('main-view');
             renderShortcutGrid(currentCategory);
        });
        document.getElementById('start-quiz-btn').addEventListener('click', () => startQuiz(currentCategory, currentShortcut));
        document.getElementById('submit-answer-btn').addEventListener('click', handleSubmitAnswer);
        document.getElementById('quiz-answer').addEventListener('keyup', (e) => {
            if (e.key === 'Enter') handleSubmitAnswer();
        });
        document.getElementById('close-results-btn').addEventListener('click', closeResultsModal);
        document.getElementById('close-express-btn').addEventListener('click', () => {
            document.getElementById('express-modal').classList.add('hidden');
        });
        document.getElementById('close-levelup-btn').addEventListener('click', () => {
            document.getElementById('levelup-modal').classList.add('hidden');
            updateGameStats();
        });
        reviewBtn.addEventListener('click', startReviewSession);

        // --- APP INITIALIZATION ---
        // authenticateUser(); // Firebase call commented out
        initializeLocalProgress(); // Use local progress instead
        updateGameStats(); // Initialize game stats display

    </script>
</body>
</html>

