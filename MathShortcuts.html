<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Shortcut Teacher</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .btn {
            display: inline-block;
            font-weight: 600;
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
            user-select: none;
            border: 1px solid transparent;
            padding: 0.5rem 1rem;
            font-size: 1rem;
            border-radius: 0.5rem;
            transition: all 0.15s ease-in-out;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #1f2937;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .progress-bar-bg {
            background-color: #e5e7eb;
            border-radius: 9999px;
            height: 8px;
        }
        .progress-bar {
            background-color: #4ade80;
            height: 100%;
            border-radius: 9999px;
            transition: width 0.3s ease-in-out;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            max-width: 90%;
            width: 500px;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold text-gray-900 sm:text-5xl">Math Shortcut Teacher</h1>
            <p class="mt-4 text-xl text-gray-600">Learn mental math tricks with spaced repetition.</p>
            <div id="user-info" class="mt-4 text-sm text-gray-500"></div>
        </header>

        <!-- Main View: Category/Shortcut Selection -->
        <main id="main-view">
            <div id="main-view-controls" class="flex justify-center mb-6 space-x-4">
                 <button id="review-btn" class="btn btn-primary text-lg px-8 py-3">Start Review Session</button>
                 <button id="back-to-categories-btn" class="btn btn-secondary text-lg px-8 py-3 hidden">&larr; Back to Categories</button>
            </div>
           
            <div id="category-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Category cards will be injected here -->
            </div>
            <div id="shortcut-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
                <!-- Shortcut cards will be injected here -->
            </div>
        </main>

        <!-- Learn View: Shortcut Explanation & Examples -->
        <section id="learn-view" class="hidden">
            <div class="card p-8 max-w-4xl mx-auto">
                <button id="back-to-main-btn" class="btn btn-secondary mb-6">&larr; Back to Tips</button>
                <h2 id="learn-title" class="text-3xl font-bold mb-4"></h2>
                <p id="learn-explanation" class="text-lg text-gray-600 mb-6"></p>
                <h3 class="text-2xl font-semibold mb-4">Examples</h3>
                <div id="learn-examples" class="space-y-3 text-gray-700 text-lg"></div>
                <div class="text-center mt-8">
                    <button id="start-quiz-btn" class="btn btn-primary px-8 py-3 text-lg">I'm Ready for the Quiz!</button>
                </div>
            </div>
        </section>

        <!-- Quiz View -->
        <section id="quiz-view" class="hidden">
             <div class="card p-8 max-w-2xl mx-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="quiz-title" class="text-2xl font-bold">Quiz Time!</h2>
                    <div id="quiz-progress" class="text-lg font-medium"></div>
                </div>
                <div class="mb-6">
                    <div class="text-5xl font-bold text-center text-gray-800 py-8" id="quiz-question"></div>
                </div>
                <div class="flex flex-col items-center">
                    <input type="number" id="quiz-answer" class="text-center text-2xl p-3 border-2 border-gray-300 rounded-lg w-full max-w-xs focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Your Answer">
                    <button id="submit-answer-btn" class="btn btn-primary mt-4 w-full max-w-xs text-lg">Submit</button>
                    <p id="feedback" class="mt-4 h-6 text-lg font-medium"></p>
                </div>
             </div>
        </section>

    </div>

    <!-- Quiz Results Modal -->
    <div id="results-modal" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <h2 class="text-3xl font-bold mb-4">Quiz Complete!</h2>
            <p class="text-5xl font-extrabold mb-2" id="results-score"></p>
            <p class="text-lg text-gray-600 mb-6" id="results-message"></p>
            <button id="close-results-btn" class="btn btn-primary">Continue Learning</button>
        </div>
    </div>


    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIG (will be populated in the environment) ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { 
            apiKey: "YOUR_API_KEY", 
            authDomain: "YOUR_AUTH_DOMAIN", 
            projectId: "YOUR_PROJECT_ID" 
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- FIREBASE INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- GLOBAL STATE & DOM ELEMENTS ---
        let userId = null;
        let userProgress = {};
        let currentCategory = null;
        let currentShortcut = null;
        let quizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;

        const mainView = document.getElementById('main-view');
        const learnView = document.getElementById('learn-view');
        const quizView = document.getElementById('quiz-view');
        const categoryGrid = document.getElementById('category-grid');
        const shortcutGrid = document.getElementById('shortcut-grid');
        const reviewBtn = document.getElementById('review-btn');
        const backToCategoriesBtn = document.getElementById('back-to-categories-btn');
        const userInfo = document.getElementById('user-info');
        
        // --- MATH SHORTCUTS DATA ---
        const allShortcuts = {
            addition: {
                title: 'Addition Tips',
                shortcuts: {
                    add100: { title: 'Adding 100', explanation: 'To add 100 to a number, just add 1 to the digit in the hundreds place.', generateQuestion: () => { const n = Math.floor(Math.random() * 899) + 100; return { question: `${n} + 100`, answer: n + 100 }; } },
                    bridge10: { title: 'Bridging Through 10', explanation: 'To add numbers like 8+5, first go to 10 (8+2=10), then add the rest (10+3=13).', generateQuestion: () => { const n1 = Math.floor(Math.random() * 4) + 6; const n2 = Math.floor(Math.random() * 4) + 6; return { question: `${n1} + ${n2}`, answer: n1 + n2 }; } },
                    doubles: { title: 'Learning Doubles', explanation: 'Adding a number to itself is called a double. Knowing these helps you add faster!', generateQuestion: () => { const n = Math.floor(Math.random() * 10) + 1; return { question: `${n} + ${n}`, answer: n * 2 }; } },
                    make10: { title: 'Making 10', explanation: 'Look for pairs of numbers that add up to 10. (1+9, 2+8, 3+7, 4+6, 5+5).', generateQuestion: () => { const n = Math.floor(Math.random() * 9) + 1; return { question: `${n} + ? = 10`, answer: 10 - n }; } },
                    add10: { title: 'Adding 10', explanation: 'To add 10 to a number, just add 1 to the digit in the tens place.', generateQuestion: () => { const n = Math.floor(Math.random() * 90) + 10; return { question: `${n} + 10`, answer: n + 10 }; } },
                    add9: { title: 'Adding 9', explanation: 'To add 9, you can add 10 first and then just subtract 1. It\'s often easier!', generateQuestion: () => { const n = Math.floor(Math.random() * 90) + 10; return { question: `${n} + 9`, answer: n + 9 }; } },
                    order: { title: 'Order Doesn\'t Matter', explanation: 'You can swap the numbers in an addition problem and still get the same answer. (e.g., 3 + 5 is the same as 5 + 3)', generateQuestion: () => { const n1 = Math.floor(Math.random() * 20); const n2 = Math.floor(Math.random() * 20); return { question: `${n1} + ${n2}`, answer: n1 + n2 }; } },
                    nearDoubles: { title: 'Near Doubles', explanation: 'If numbers are close together (like 6+7), use a double you know! (6+6=12), then add 1 more.', generateQuestion: () => { const n = Math.floor(Math.random() * 10) + 1; return { question: `${n} + ${n+1}`, answer: n * 2 + 1 }; } },
                    breakApart: { 
                        title: 'Break Apart Numbers', 
                        explanation: 'Break one number into smaller parts to make it easier. For 7+5, you can do 7+3=10, then add the leftover 2 to get 12.', 
                        generateQuestion: () => {
                            const n1 = Math.floor(Math.random() * 4) + 6; // 6, 7, 8, 9
                            const n2 = Math.floor(Math.random() * 5) + 5; // 5, 6, 7, 8, 9
                            const needed = 10 - n1;
                            const leftover = n2 - needed;

                            return {
                                question: `${n1} + ${n2}`,
                                answer: n1 + n2,
                                steps: { n1, n2, needed, leftover }
                            };
                        }
                    },
                    addInChunks: { title: 'Add in Chunks', explanation: 'When adding bigger numbers like 23+45, add the tens first (20+40=60), then add the ones (3+5=8). Finally, add the results (60+8=68).', generateQuestion: () => { const t1 = (Math.floor(Math.random()*4)+1)*10; const o1 = Math.floor(Math.random()*9)+1; const t2 = (Math.floor(Math.random()*4)+1)*10; const o2 = Math.floor(Math.random()*9)+1; return { question: `${t1+o1} + ${t2+o2}`, answer: t1+o1+t2+o2 }; } },
                }
            },
            subtraction: {
                title: 'Subtraction Tips',
                shortcuts: {
                    sub100: { title: 'Subtracting 100', explanation: 'To subtract 100, just take 1 away from the digit in the hundreds place.', generateQuestion: () => { const n = Math.floor(Math.random() * 899) + 101; return { question: `${n} - 100`, answer: n - 100 }; } },
                    subAcross10: { title: 'Subtracting Across 10', explanation: 'For 14-6, first go down to 10 (14-4=10), then subtract the rest (10-2=8).', generateQuestion: () => { const n1 = Math.floor(Math.random() * 8) + 11; const n2 = Math.floor(Math.random() * 5) + (n1 - 9); return { question: `${n1} - ${n2}`, answer: n1 - n2 }; } },
                    subFromFriendly: { title: 'Subtract from Friendly Numbers', explanation: 'For 50-24, you can think 50-20=30, then 30-4=26.', generateQuestion: () => { const t1 = (Math.floor(Math.random()*5)+3)*10; const n2 = Math.floor(Math.random()*20)+11; return { question: `${t1} - ${n2}`, answer: t1 - n2 }; } },
                    countUp: { title: 'Counting Up', explanation: 'For 12 - 9, start at 9 and count how many steps it takes to get to 12. (10, 11, 12... That\'s 3 steps!)', generateQuestion: () => { const n2 = Math.floor(Math.random() * 10) + 1; const diff = Math.floor(Math.random() * 5) + 2; const n1 = n2 + diff; return { question: `${n1} - ${n2}`, answer: diff }; } },
                    sub10: { title: 'Subtracting 10', explanation: 'To subtract 10 from a number, just take 1 away from the digit in the tens place.', generateQuestion: () => { const n = Math.floor(Math.random() * 90) + 11; return { question: `${n} - 10`, answer: n - 10 }; } },
                    sub9: { title: 'Subtracting 9', explanation: 'To subtract 9, you can subtract 10 first and then just add 1 back.', generateQuestion: () => { const n = Math.floor(Math.random() * 90) + 11; return { question: `${n} - 9`, answer: n - 9 }; } },
                    useAddition: { title: 'Use Addition', explanation: 'Thinking "15 - 7 = ?" is hard. Try thinking "7 + what equals 15?". They are the same problem!', generateQuestion: () => { const n2 = Math.floor(Math.random() * 10) + 1; const ans = Math.floor(Math.random() * 10) + 1; const n1 = n2 + ans; return { question: `${n1} - ${n2}`, answer: ans }; } },
                    factFamilies: { title: 'Fact Families', explanation: 'If you know 8 + 4 = 12, then you also know two subtraction facts: 12 - 8 = 4 and 12 - 4 = 8.', generateQuestion: () => { const n1 = Math.floor(Math.random()*10)+1; const n2 = Math.floor(Math.random()*10)+1; return { question: `If ${n1}+${n2}=${n1+n2}, what is ${n1+n2}-${n1}?`, answer: n2 }; } },
                    breakApartSub: { title: 'Break Apart to Subtract', explanation: 'For 15 - 8, you can do 15 - 5 = 10, then subtract the leftover 3 to get 7.', generateQuestion: () => { const n1 = Math.floor(Math.random() * 9) + 11; const n2 = Math.floor(Math.random() * 5) + (n1-9); return { question: `${n1} - ${n2}`, answer: n1 - n2 }; } },
                    constantDiff: { title: 'Keep the Difference', explanation: '27-19 is hard. If you add 1 to both numbers, it becomes 28-20, which is an easy 8! The answer is the same.', generateQuestion: () => { const n2 = Math.floor(Math.random() * 50) + 9; const n1 = n2 + Math.floor(Math.random()*10)+5; return { question: `${n1} - ${n2}`, answer: n1-n2}; } }
                }
            },
            multiplication: {
                title: 'Multiplication Tips',
                shortcuts: {
                    multBy25: { title: 'Multiply by 25', explanation: 'To multiply by 25, think about quarters. 4 x 25 = 100. So, divide the other number by 4 and add two zeros.', generateQuestion: () => { const n = (Math.floor(Math.random()*10)+1)*4; return { question: `${n} x 25`, answer: n * 25 }; } },
                    multByMultiplesOf10: { title: 'Multiply by Multiples of 10', explanation: 'For 7 x 30, just do 7 x 3 = 21, and then add the zero back on. Answer: 210.', generateQuestion: () => { const n1 = Math.floor(Math.random()*9)+2; const n2 = (Math.floor(Math.random()*9)+2)*10; return { question: `${n1} x ${n2}`, answer: n1 * n2 }; } },
                    mult2: { title: 'Multiply by 2 (Doubling)', explanation: 'Multiplying by 2 is the same as adding a number to itself (doubling it).', generateQuestion: () => { const n = Math.floor(Math.random() * 20) + 1; return { question: `${n} x 2`, answer: n * 2 }; } },
                    mult5: { title: 'Multiply by 5', explanation: 'Numbers multiplied by 5 always end in a 0 or a 5. You can also multiply by 10 and then cut it in half.', generateQuestion: () => { const n = Math.floor(Math.random() * 20) + 1; return { question: `${n} x 5`, answer: n * 5 }; } },
                    mult10: { title: 'Multiply by 10', explanation: 'To multiply any number by 10, just put a 0 on the end of it.', generateQuestion: () => { const n = Math.floor(Math.random() * 50) + 1; return { question: `${n} x 10`, answer: n * 10 }; } },
                    mult11simple: { title: 'Multiply by 11 (Easy)', explanation: 'To multiply a single-digit number by 11, just write that digit twice (e.g., 4 x 11 = 44).', generateQuestion: () => { const n = Math.floor(Math.random() * 9) + 1; return { question: `${n} x 11`, answer: n * 11 }; } },
                    orderMult: { title: 'Order Doesn\'t Matter', explanation: 'You can swap numbers in a multiplication problem and get the same answer (e.g., 3 x 6 is the same as 6 x 3).', generateQuestion: () => { const n1 = Math.floor(Math.random() * 10); const n2 = Math.floor(Math.random() * 10); return { question: `${n1} x ${n2}`, answer: n1 * n2 }; } },
                    mult4: { title: 'Multiply by 4', explanation: 'To multiply a number by 4, just double it, and then double the result.', generateQuestion: () => { const n = Math.floor(Math.random() * 15) + 1; return { question: `${n} x 4`, answer: n * 4 }; } },
                    mult9fingers: { title: 'Multiply by 9 (Finger Trick)', explanation: 'Hold up 10 fingers. To multiply 9x3, bend down your 3rd finger. You have 2 fingers on the left and 7 on the right. The answer is 27!', generateQuestion: () => { const n = Math.floor(Math.random() * 9) + 2; return { question: `${n} x 9`, answer: n * 9 }; } },
                    mult11adv: { title: 'Multiply by 11 (Advanced)', explanation: 'To multiply a two-digit number by 11 (like 25x11), add the two digits (2+5=7) and put the sum in the middle. Answer: 275.', generateQuestion: () => { const n = Math.floor(Math.random() * 8) + 2; const n2 = Math.floor(Math.random()*(9-n))+1; const finalNum = n*10+n2; return { question: `${finalNum} x 11`, answer: finalNum*11}; } },
                }
            },
            division: {
                title: 'Division Tips',
                shortcuts: {
                    divBy4: { title: 'Divide by 4', explanation: 'To divide by 4, you can just cut the number in half, and then cut it in half again.', generateQuestion: () => { const n = (Math.floor(Math.random()*10)+1)*4; return { question: `${n} / 4`, answer: n / 4 }; } },
                    ruleFor3: { title: 'Rule for 3', explanation: 'You can divide a number by 3 if the sum of its digits is divisible by 3.', generateQuestion: () => { const n = Math.floor(Math.random() * 100) + 10; const sumOfDigits = String(n).split('').reduce((acc, digit) => acc + parseInt(digit), 0); return { question: `Is ${n} divisible by 3? (1 for yes, 0 for no)`, answer: sumOfDigits % 3 === 0 ? 1 : 0 }; } },
                    div0: { title: 'Dividing 0', explanation: '0 divided by any other number is always 0.', generateQuestion: () => { const n = Math.floor(Math.random() * 100) + 1; return { question: `0 / ${n}`, answer: 0 }; } },
                    div2: { title: 'Divide by 2 (Halving)', explanation: 'Dividing by 2 is the same as cutting a number in half.', generateQuestion: () => { const n = (Math.floor(Math.random() * 25) + 1) * 2; return { question: `${n} / 2`, answer: n / 2 }; } },
                    div10: { title: 'Divide by 10', explanation: 'To divide a number ending in 0 by 10, just remove the 0.', generateQuestion: () => { const n = (Math.floor(Math.random() * 20) + 1) * 10; return { question: `${n} / 10`, answer: n / 10 }; } },
                    useMult: { title: 'Use Multiplication', explanation: 'Thinking "30 / 6 = ?" is hard. Try thinking "6 x what equals 30?".', generateQuestion: () => { const ans = Math.floor(Math.random()*10)+1; const n2 = Math.floor(Math.random()*10)+1; return { question: `${ans*n2} / ${n2}`, answer: ans}; } },
                    factFamiliesDiv: { title: 'Fact Families', explanation: 'If you know 5 x 6 = 30, you also know two division facts: 30 / 5 = 6 and 30 / 6 = 5.', generateQuestion: () => { const n1 = Math.floor(Math.random()*10)+1; const n2 = Math.floor(Math.random()*10)+1; return { question: `If ${n1}x${n2}=${n1*n2}, what is ${n1*n2}/${n1}?`, answer: n2 }; } },
                    ruleFor2: { title: 'Rule for 2', explanation: 'You can divide a number by 2 if it is an even number (it ends in 0, 2, 4, 6, or 8).', generateQuestion: () => { const n = Math.floor(Math.random() * 100); return { question: `Is ${n} divisible by 2? (1 for yes, 0 for no)`, answer: n % 2 === 0 ? 1 : 0 }; } },
                    ruleFor5: { title: 'Rule for 5', explanation: 'You can divide a number by 5 if it ends in a 0 or a 5.', generateQuestion: () => { const n = Math.floor(Math.random() * 100); return { question: `Is ${n} divisible by 5? (1 for yes, 0 for no)`, answer: n % 5 === 0 ? 1 : 0 }; } },
                    ruleFor10: { title: 'Rule for 10', explanation: 'You can divide a number by 10 if it ends in a 0.', generateQuestion: () => { const n = Math.floor(Math.random() * 100); return { question: `Is ${n} divisible by 10? (1 for yes, 0 for no)`, answer: n % 10 === 0 ? 1 : 0 }; } },
                }
            }
        };
        
        // --- AUTHENTICATION & DATA HANDLING ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userInfo.textContent = `User ID: ${userId}`;
                await setupUserListener();
            }
        });
        
        async function authenticateUser() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                userInfo.innerHTML = `<span class="text-red-600 font-semibold">Could not save progress.</span> Is the Firebase config correct and is Anonymous Sign-in enabled in your project?`;
            }
        }
        
        async function setupUserListener() {
            if (!userId) return;
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/mathShortcutsProgress/data`);
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    userProgress = docSnap.data();
                } else {
                    // Initialize progress for new nested structure
                    userProgress = {};
                    for (const catKey in allShortcuts) {
                        userProgress[catKey] = {};
                        for (const shortKey in allShortcuts[catKey].shortcuts) {
                            userProgress[catKey][shortKey] = { strength: 0, lastReviewed: null };
                        }
                    }
                    saveProgress();
                }
                renderCategories();
            }, (error) => {
                console.error("Error listening to progress:", error);
            });
        }
        
        async function saveProgress() {
            if (!userId) return;
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/mathShortcutsProgress/data`);
            try {
                await setDoc(docRef, userProgress);
            } catch (error) {
                console.error("Error saving progress: ", error);
            }
        }
        
        // --- VIEW RENDERING & SWITCHING ---
        function switchView(view) {
            mainView.classList.add('hidden');
            learnView.classList.add('hidden');
            quizView.classList.add('hidden');
            document.getElementById(view).classList.remove('hidden');
        }

        function renderCategories() {
            currentCategory = null;
            categoryGrid.innerHTML = '';
            categoryGrid.classList.remove('hidden');
            shortcutGrid.classList.add('hidden');
            backToCategoriesBtn.classList.add('hidden');
            reviewBtn.classList.remove('hidden');

            Object.entries(allShortcuts).forEach(([key, category]) => {
                const card = document.createElement('div');
                card.className = 'card p-8 cursor-pointer text-center';
                card.dataset.category = key;
                card.innerHTML = `<h2 class="text-3xl font-bold">${category.title}</h2>`;
                card.addEventListener('click', () => renderShortcutGrid(key));
                categoryGrid.appendChild(card);
            });
        }

        function renderShortcutGrid(categoryKey) {
            currentCategory = categoryKey;
            shortcutGrid.innerHTML = '';
            categoryGrid.classList.add('hidden');
            shortcutGrid.classList.remove('hidden');
            backToCategoriesBtn.classList.remove('hidden');
            reviewBtn.classList.add('hidden');

            const category = allShortcuts[categoryKey];
            Object.entries(category.shortcuts).forEach(([key, shortcut]) => {
                const progress = userProgress[categoryKey]?.[key] || { strength: 0 };
                const strength = progress.strength || 0;
                const card = document.createElement('div');
                card.className = 'card p-6 cursor-pointer';
                card.dataset.shortcut = key;
                card.innerHTML = `
                    <h3 class="text-xl font-bold mb-2">${shortcut.title}</h3>
                    <div class="progress-bar-bg w-full">
                        <div class="progress-bar" style="width: ${strength * 20}%"></div>
                    </div>
                    <span class="text-sm text-gray-500 mt-1 block">Mastery: ${strength}/5</span>
                `;
                card.addEventListener('click', () => showLearnView(categoryKey, key));
                shortcutGrid.appendChild(card);
            });
        }

        function showLearnView(categoryKey, shortcutKey) {
            currentCategory = categoryKey;
            currentShortcut = shortcutKey;
            const shortcut = allShortcuts[categoryKey].shortcuts[shortcutKey];
            document.getElementById('learn-title').textContent = shortcut.title;
            document.getElementById('learn-explanation').textContent = shortcut.explanation;
            
            const examplesContainer = document.getElementById('learn-examples');
            examplesContainer.innerHTML = ''; // Clear previous examples
            
            // Generate 5 examples
            for (let i = 0; i < 5; i++) {
                const ex = shortcut.generateQuestion();
                let questionText = ex.question;

                // SPECIAL CASE: Detailed example for 'Break Apart Numbers'
                if (shortcutKey === 'breakApart' && ex.steps) {
                    const { n1, n2, needed, leftover } = ex.steps;
                    examplesContainer.innerHTML += `
                        <div class="bg-gray-100 p-4 rounded-md space-y-1">
                            <p class="font-semibold text-lg">${n1} + ${n2}</p>
                            <p class="text-gray-600 pl-4">Break ${n2} into <span class="font-semibold">${needed} + ${leftover}</span> to help ${n1} get to 10.</p>
                            <p class="pl-4 font-mono text-gray-800">${n1} + (${needed} + ${leftover})</p>
                            <p class="pl-4 font-mono text-gray-800">(${n1} + ${needed}) + ${leftover}</p>
                            <p class="pl-4 font-mono text-gray-800">10 + ${leftover} = <span class="text-indigo-600 font-bold">${ex.answer}</span></p>
                        </div>`;
                } 
                // CASE: For 'yes/no' divisibility questions
                else if (questionText.includes('? (1 for yes, 0 for no)')) {
                    questionText = questionText.replace('? (1 for yes, 0 for no)', '');
                    examplesContainer.innerHTML += `<div class="bg-gray-100 p-3 rounded-md">
                        <span class="font-semibold">${questionText}</span>: <span class="text-indigo-600 font-bold">${ex.answer === 1 ? 'Yes' : 'No'}</span>
                    </div>`;
                } 
                // DEFAULT: Simple question = answer format
                else {
                     examplesContainer.innerHTML += `<div class="bg-gray-100 p-3 rounded-md">
                        <span class="font-semibold">${ex.question}</span> = <span class="text-indigo-600 font-bold">${ex.answer}</span>
                    </div>`;
                }
            }

            switchView('learn-view');
        }


        // --- QUIZ LOGIC ---
        function startQuiz(categoryKey, shortcutKey) {
            currentCategory = categoryKey;
            currentShortcut = shortcutKey;
            currentQuestionIndex = 0;
            score = 0;
            quizQuestions = [];
            const shortcut = allShortcuts[categoryKey].shortcuts[shortcutKey];
            for (let i = 0; i < 10; i++) {
                quizQuestions.push(shortcut.generateQuestion());
            }
            document.getElementById('quiz-title').textContent = `${shortcut.title} Quiz`;
            switchView('quiz-view');
            displayNextQuestion();
        }

        function displayNextQuestion() {
            if (currentQuestionIndex >= quizQuestions.length) {
                endQuiz();
                return;
            }

            const q = quizQuestions[currentQuestionIndex];
            document.getElementById('quiz-progress').textContent = `Question ${currentQuestionIndex + 1}/10`;
            document.getElementById('quiz-question').textContent = q.question;
            const answerInput = document.getElementById('quiz-answer');
            answerInput.value = '';
            answerInput.focus();
            document.getElementById('feedback').textContent = '';
        }
        
        function handleSubmitAnswer() {
            if (currentQuestionIndex >= quizQuestions.length) return; // FIX: Prevent running after quiz ends
            const feedbackEl = document.getElementById('feedback');
            const userAnswer = parseInt(document.getElementById('quiz-answer').value, 10);
            const correctAnswer = quizQuestions[currentQuestionIndex].answer;

            if (isNaN(userAnswer)) {
                feedbackEl.textContent = "Please enter a number.";
                feedbackEl.className = "mt-4 h-6 text-lg font-medium text-yellow-600";
                return;
            }

            if (userAnswer === correctAnswer) {
                score++;
                feedbackEl.textContent = "Correct!";
                feedbackEl.className = "mt-4 h-6 text-lg font-medium text-green-600";
            } else {
                feedbackEl.textContent = `Incorrect. The answer was ${correctAnswer}.`;
                feedbackEl.className = "mt-4 h-6 text-lg font-medium text-red-600";
            }

            currentQuestionIndex++;
            setTimeout(displayNextQuestion, 1200);
        }

        function endQuiz() {
            const progress = userProgress[currentCategory][currentShortcut];
            
            if (score >= 8) {
                progress.strength = Math.min(5, progress.strength + 1);
            } else if (score < 5 && progress.strength > 0) {
                 progress.strength = Math.max(0, progress.strength - 1);
            }
            progress.lastReviewed = new Date().toISOString();
            
            saveProgress();
            showResultsModal();
        }

        // --- SPACED REPETITION ---
        function startReviewSession() {
            let nextShortcut = null;
            let minStrength = 6;
            let oldestDate = new Date().toISOString();

            for (const catKey in userProgress) {
                for (const shortKey in userProgress[catKey]) {
                    const progress = userProgress[catKey][shortKey];
                    if (progress.strength >= 5) continue;

                    if (progress.strength < minStrength) {
                        minStrength = progress.strength;
                        oldestDate = progress.lastReviewed || '1970-01-01T00:00:00.000Z';
                        nextShortcut = { category: catKey, shortcut: shortKey };
                    } else if (progress.strength === minStrength) {
                        const currentLastReviewed = progress.lastReviewed || '1970-01-01T00:00:00.000Z';
                        if (currentLastReviewed < oldestDate) {
                            oldestDate = currentLastReviewed;
                            nextShortcut = { category: catKey, shortcut: shortKey };
                        }
                    }
                }
            }
            
            if (!nextShortcut) { // If all are mastered, pick a random one
                const categories = Object.keys(allShortcuts);
                const randomCategory = categories[Math.floor(Math.random() * categories.length)];
                const shortcuts = Object.keys(allShortcuts[randomCategory].shortcuts);
                const randomShortcut = shortcuts[Math.floor(Math.random() * shortcuts.length)];
                nextShortcut = { category: randomCategory, shortcut: randomShortcut };
            }

            showLearnView(nextShortcut.category, nextShortcut.shortcut);
        }
        
        // --- MODAL & UI ---
        function showResultsModal() {
            const modal = document.getElementById('results-modal');
            document.getElementById('results-score').textContent = `${score} / 10`;
            let message = "Good effort! Keep practicing.";
            if (score >= 8) message = "Excellent work! You're getting the hang of it.";
            if (score === 10) message = "Perfect score! You've mastered this.";
            document.getElementById('results-message').textContent = message;
            modal.classList.remove('hidden');
        }

        function closeResultsModal() {
            document.getElementById('results-modal').classList.add('hidden');
            switchView('main-view');
            // If we were in a category, go back to that category grid
            if(currentCategory) {
                renderShortcutGrid(currentCategory);
            } else {
                renderCategories();
            }
        }
        
        // --- EVENT LISTENERS ---
        backToCategoriesBtn.addEventListener('click', renderCategories);
        document.getElementById('back-to-main-btn').addEventListener('click', () => {
             switchView('main-view');
             renderShortcutGrid(currentCategory);
        });
        document.getElementById('start-quiz-btn').addEventListener('click', () => startQuiz(currentCategory, currentShortcut));
        document.getElementById('submit-answer-btn').addEventListener('click', handleSubmitAnswer);
        document.getElementById('quiz-answer').addEventListener('keyup', (e) => {
            if (e.key === 'Enter') handleSubmitAnswer();
        });
        document.getElementById('close-results-btn').addEventListener('click', closeResultsModal);
        reviewBtn.addEventListener('click', startReviewSession);

        // --- APP INITIALIZATION ---
        authenticateUser();

    </script>
</body>
</html>

