<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöá Subway Math</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --subway-red: #EE352E;
            --subway-dark-red: #B71C1C;
            --subway-orange: #FF6319;
            --subway-blue: #0039A6;
            --subway-green: #6CBE45;
            --subway-yellow: #FCCC0A;
            --dark-bg: #050810;
            --card-bg: #0d1117;
            --card-hover: #161b22;
            --accent-color: var(--subway-red);
        }

        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
            background: linear-gradient(135deg, #020408 0%, #0a0e14 100%);
            background-attachment: fixed;
        }

        .subway-bg {
            background-image:
                repeating-linear-gradient(90deg, transparent, transparent 50px, rgba(255,255,255,0.03) 50px, rgba(255,255,255,0.03) 51px),
                repeating-linear-gradient(0deg, transparent, transparent 50px, rgba(255,255,255,0.03) 50px, rgba(255,255,255,0.03) 51px);
        }

        .card {
            background: linear-gradient(135deg, var(--card-bg) 0%, #1a1f2e 100%);
            border-radius: 1rem;
            border: 2px solid rgba(238, 53, 46, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease-in-out;
        }

        .card:hover {
            transform: translateY(-8px) scale(1.02);
            border-color: var(--subway-red);
            box-shadow: 0 12px 48px rgba(238, 53, 46, 0.3);
        }

        .btn {
            display: inline-block;
            font-weight: 700;
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
            user-select: none;
            border: 2px solid transparent;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--subway-red) 0%, var(--subway-dark-red) 100%);
            color: #fff;
            border-color: var(--subway-red);
        }

        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 24px rgba(238, 53, 46, 0.6);
        }

        .btn-secondary {
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
            border-color: rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background-color: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .progress-bar-bg {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 9999px;
            height: 12px;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--subway-red) 0%, var(--subway-orange) 100%);
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
            box-shadow: 0 0 20px rgba(238, 53, 46, 0.6);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .modal-content {
            background: linear-gradient(135deg, var(--card-bg) 0%, #1a1f2e 100%);
            border: 2px solid var(--subway-red);
            padding: 2.5rem;
            border-radius: 1rem;
            max-width: 90%;
            width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
        }

        .coin-float {
            animation: coinFloat 1s ease-out forwards;
        }

        @keyframes coinFloat {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(1.5); opacity: 0; }
        }

        .level-up {
            animation: levelUp 0.6s ease-out;
        }

        @keyframes levelUp {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .pulse-glow {
            animation: pulseGlow 2s infinite;
        }

        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(252, 204, 10, 0.3); }
            50% { box-shadow: 0 0 40px rgba(252, 204, 10, 0.6); }
        }

        .subway-line {
            display: inline-block;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            font-weight: 900;
            font-size: 14px;
            color: white;
            margin-right: 8px;
        }

        /* Hamburger Menu Styles */
        .menu-btn {
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: all 0.3s;
        }

        .menu-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .menu-item {
            padding: 1rem;
            border-bottom: 1px solid rgba(238, 53, 46, 0.2);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .menu-item:hover {
            background: rgba(238, 53, 46, 0.1);
            border-left: 4px solid var(--subway-red);
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .express-train {
            animation: expressTrain 0.5s ease-in-out;
            background: linear-gradient(45deg, var(--subway-red), var(--subway-orange));
        }

        @keyframes expressTrain {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .coin-icon {
            display: inline-block;
            color: var(--subway-yellow);
            font-weight: 900;
            text-shadow: 0 0 10px rgba(252, 204, 10, 0.5);
        }

        /* STORE STYLES */
        .store-item {
            background: var(--card-bg);
            border: 2px solid rgba(238, 53, 46, 0.3);
            border-radius: 0.75rem;
            padding: 1rem;
            transition: all 0.3s;
            cursor: pointer;
        }

        .store-item:hover:not(.owned) {
            border-color: var(--subway-red);
            transform: scale(1.05);
        }

        .store-item.owned {
            opacity: 0.6;
            border-color: var(--subway-green);
            cursor: not-allowed;
        }

        .store-item.equipped {
            border-color: var(--subway-yellow);
            box-shadow: 0 0 20px rgba(252, 204, 10, 0.4);
        }

        /* CONDUCTOR VISUAL */
        .conductor-container {
            position: relative;
            width: 200px;
            height: 300px;
            margin: 0 auto;
        }

        .conductor-base {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #4A5568 0%, #2D3748 100%);
            border-radius: 50% 50% 0 0 / 60% 60% 0 0;
        }

        .conductor-face {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 120px;
            background: #FDB07C;
            border-radius: 50%;
            z-index: 1;
        }

        .conductor-eye {
            position: absolute;
            top: 40px;
            width: 15px;
            height: 15px;
            background: #2D3748;
            border-radius: 50%;
        }

        .conductor-eye-left {
            left: 30px;
        }

        .conductor-eye-right {
            right: 30px;
        }

        .conductor-smile {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 25px;
            border: 3px solid #2D3748;
            border-top: none;
            border-radius: 0 0 50px 50px;
        }

        .conductor-hair {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 130px;
            height: 60px;
            background: #3B2817;
            border-radius: 50%;
            z-index: 0;
        }

        .conductor-item {
            position: absolute;
            transition: all 0.3s;
            z-index: 2;
        }

        .conductor-item.hat-slot {
            font-size: 4rem;
        }

        .conductor-item.accessory-slot {
            font-size: 3rem;
        }

        /* SUBWAY CAR VISUAL */
        .subway-car-container {
            position: relative;
            width: 100%;
            height: 150px;
            overflow: hidden;
            background: linear-gradient(180deg, #0a0e14 0%, #020408 100%);
            border-radius: 1rem;
            border: 2px solid rgba(238, 53, 46, 0.3);
        }

        .subway-car {
            position: absolute;
            left: 0;
            transition: left 1s ease-in-out;
        }

        .subway-track {
            position: absolute;
            bottom: 20px;
            width: 100%;
            height: 4px;
            background: repeating-linear-gradient(
                90deg,
                #4A5568 0px,
                #4A5568 20px,
                transparent 20px,
                transparent 40px
            );
        }

        /* STATION CUTSCENE */
        .station-cutscene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .subway-doors {
            position: relative;
            width: 80%;
            max-width: 600px;
            height: 400px;
            background: var(--subway-red);
            border-radius: 1rem;
            overflow: hidden;
        }

        .door {
            position: absolute;
            top: 0;
            width: 50%;
            height: 100%;
            background: linear-gradient(90deg, #B71C1C 0%, #EE352E 50%, #B71C1C 100%);
            transition: transform 1s ease-in-out;
        }

        .door-left {
            left: 0;
            border-right: 4px solid #000;
        }

        .door-right {
            right: 0;
            border-left: 4px solid #000;
        }

        .doors-open .door-left {
            transform: translateX(-100%);
        }

        .doors-open .door-right {
            transform: translateX(100%);
        }

        .crowd {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 60%;
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .doors-open .crowd {
            opacity: 1;
        }

        .person {
            width: 40px;
            height: 80px;
            background: #4A5568;
            border-radius: 50% 50% 0 0;
            margin: 0 5px;
            animation: crowd-shuffle 2s ease-in-out infinite;
        }

        @keyframes crowd-shuffle {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(10px); }
        }

        .pulse-glow {
            animation: pulseGlow 2s infinite;
        }

        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(238, 53, 46, 0.4); }
            50% { box-shadow: 0 0 40px rgba(238, 53, 46, 0.8); }
        }

        /* Animated Subway Icon */
        @keyframes subwaySlide {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100vw); }
        }

        .subway-icon {
            display: inline-block;
            animation: subwaySlide 8s linear infinite;
            font-size: 2.5rem;
            margin-left: 1rem;
        }

        /* SUBWAY PROGRESS VISUALIZATION */
        .subway-progress-track {
            position: relative;
            width: 100%;
            height: 60px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 2rem;
            overflow: hidden;
        }

        .train-car {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            font-size: 2rem;
            transition: left 0.5s ease-out;
        }

        .station-marker {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: var(--subway-red);
            border-radius: 50%;
            border: 2px solid #fff;
        }
    </style>
</head>
<body class="text-white subway-bg">

    <div id="app" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Game Stats Header -->
        <header class="mb-8">
            <!-- Top Bar with Title and Menu -->
            <div class="flex justify-between items-center mb-6">
                <div class="flex-1">
                    <h1 class="text-3xl sm:text-4xl md:text-5xl font-black bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500 bg-clip-text text-transparent">
                        üöá Subway Math
                    </h1>
                    <p class="mt-1 text-sm sm:text-base text-gray-300">Master Vedic Math!</p>
                </div>
                <div class="menu-btn text-4xl" onclick="toggleMenu()">
                    ‚ò∞
                </div>
            </div>

            <!-- Compact Stats Bar -->
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-4">
                <!-- Coins -->
                <div class="card p-3 text-center">
                    <div class="text-2xl sm:text-3xl font-black coin-icon">üí∞ <span id="coin-count">0</span></div>
                    <div class="text-xs text-gray-400 mt-1">COINS</div>
                </div>

                <!-- Level & Station -->
                <div class="card p-3 text-center">
                    <div class="text-xl sm:text-2xl font-bold">
                        <span class="subway-line" style="background-color: var(--subway-red); color: #fff;" id="level-badge">2</span>
                        <span id="station-name" class="text-white text-sm sm:text-base">96th St</span>
                    </div>
                    <div class="text-xs text-gray-400 mt-1">STATION</div>
                </div>

                <!-- Passengers -->
                <div class="card p-3 text-center col-span-2 md:col-span-1">
                    <div class="text-xl sm:text-2xl font-bold">
                        üë• <span id="passenger-count">0</span>/<span id="max-passengers">30</span>
                    </div>
                    <div class="text-xs text-gray-400 mt-1">PASSENGERS</div>
                </div>
            </div>

            <!-- Progress to Next Station (Compact) -->
            <div class="card p-3 mb-4">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-xs text-gray-400">NEXT STATION</div>
                    <div class="text-xs text-gray-300">
                        <span id="distance-current">0</span>m / <span id="distance-needed">100</span>m
                    </div>
                </div>
                <div class="progress-bar-bg">
                    <div class="progress-bar" id="distance-progress" style="width: 0%"></div>
                </div>
            </div>

            <div id="user-info" class="text-center text-sm text-gray-500"></div>
        </header>

        <!-- Main View: Category/Shortcut Selection -->
        <main id="main-view">
            <div id="main-view-controls" class="flex flex-col items-center mb-8 space-y-4">
                 <button id="review-btn" class="btn btn-primary text-2xl sm:text-3xl px-12 py-6 w-full max-w-md pulse-glow">
                    üöÄ START LEARNING
                 </button>
                 <button id="back-to-categories-btn" class="btn btn-secondary text-base px-6 py-3 hidden">‚¨ÖÔ∏è Back to Categories</button>
            </div>

            <div id="category-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Category cards will be injected here -->
            </div>
            <div id="shortcut-grid-wrapper" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <button id="back-to-categories-btn-2" class="btn btn-secondary">‚¨ÖÔ∏è Back to Categories</button>
                    <h2 id="category-title" class="text-3xl font-bold text-white"></h2>
                    <div></div>
                </div>
                <div id="shortcut-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Shortcut cards will be injected here -->
                </div>
            </div>
        </main>

        <!-- Learn View: Shortcut Explanation & Examples -->
        <section id="learn-view" class="hidden">
            <div class="card p-8 max-w-5xl mx-auto">
                <button id="back-to-main-btn" class="btn btn-secondary mb-6">‚¨ÖÔ∏è Back to Station</button>
                <h2 id="learn-title" class="text-4xl font-black text-red-400 mb-4"></h2>

                <!-- Video Tutorial (Dynamically Generated) -->
                <div id="video-section" class="mb-8 bg-gray-900 border-2 border-red-400/30 rounded-lg p-6">
                    <!-- Content will be filled by JavaScript -->
                </div>

                <!-- Written Explanation -->
                <div class="mb-8">
                    <h3 class="text-2xl font-bold text-white mb-4">üìñ How It Works</h3>
                    <p id="learn-explanation" class="text-xl text-gray-300 leading-relaxed bg-gray-800 p-6 rounded-lg border border-red-400/20"></p>
                </div>

                <!-- Step-by-Step Breakdown -->
                <div class="mb-8" id="step-by-step-section">
                    <h3 class="text-2xl font-bold text-white mb-4">üî¢ Step-by-Step</h3>
                    <div id="step-by-step" class="space-y-3"></div>
                </div>

                <!-- Subway Word Problems -->
                <div class="mb-8">
                    <h3 class="text-2xl font-bold text-white mb-4">üöá Subway Word Problems</h3>
                    <div id="word-problems" class="space-y-4"></div>
                </div>

                <!-- Practice Examples -->
                <div class="mb-8">
                    <h3 class="text-2xl font-bold text-white mb-4">üìù Practice Examples</h3>
                    <div id="learn-examples" class="space-y-3 text-lg"></div>
                </div>

                <p class="text-center text-gray-400 mt-6 italic text-lg">üí° Pro tip: Try solving in your head before looking at answers!</p>
                <div class="text-center mt-8">
                    <button id="start-quiz-btn" class="btn btn-primary px-12 py-4 text-xl">üöÄ START QUIZ! (+50 COINS)</button>
                </div>
            </div>
        </section>

        <!-- Quiz View -->
        <section id="quiz-view" class="hidden">
             <div class="card p-8 max-w-2xl mx-auto relative">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="quiz-title" class="text-2xl font-bold text-white">Quiz Time!</h2>
                    <div id="quiz-progress" class="text-lg font-medium text-gray-300"></div>
                </div>
                <div class="mb-6">
                    <div class="text-6xl font-black text-center text-red-400 py-8" id="quiz-question"></div>
                </div>
                <div class="flex flex-col items-center relative" id="answer-container">
                    <input type="number" id="quiz-answer" class="text-center text-3xl p-4 border-2 border-red-400 rounded-lg w-full max-w-xs bg-gray-900 text-white focus:ring-2 focus:ring-red-500 focus:border-red-500" placeholder="?">
                    <button id="submit-answer-btn" class="btn btn-primary mt-4 w-full max-w-xs text-lg">Submit Answer</button>
                    <p id="feedback" class="mt-4 h-8 text-xl font-bold"></p>
                    <!-- Coin animation container -->
                    <div id="coin-animation-container" class="absolute top-0 left-1/2 transform -translate-x-1/2"></div>
                </div>
             </div>
        </section>

    </div>

    <!-- Quiz Results Modal -->
    <div id="results-modal" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <h2 class="text-4xl font-black text-red-400 mb-4">üéâ QUIZ COMPLETE! üéâ</h2>
            <p class="text-6xl font-extrabold mb-4 text-white" id="results-score"></p>
            <div class="text-3xl font-bold mb-4 coin-icon">
                üí∞ +<span id="coins-earned">0</span> COINS
            </div>
            <div class="text-xl font-bold mb-6 text-red-400">
                üöá +<span id="xp-earned">0</span> METERS
            </div>
            <p class="text-lg text-gray-300 mb-6" id="results-message"></p>
            <button id="close-results-btn" class="btn btn-primary">Continue Journey</button>
        </div>
    </div>

    <!-- Express Train Bonus Modal -->
    <div id="express-modal" class="modal-overlay hidden">
        <div class="modal-content text-center express-train">
            <h2 class="text-5xl font-black text-white mb-4">üöÑ EXPRESS TRAIN ACTIVATED! üöÑ</h2>
            <p class="text-3xl font-bold text-yellow-300 mb-6">2x COIN MULTIPLIER!</p>
            <p class="text-xl text-white mb-6">You've been grinding for 3 minutes! All coins are now DOUBLED!</p>
            <button id="close-express-btn" class="btn btn-primary">LET'S GO!</button>
        </div>
    </div>

    <!-- Level Up Modal -->
    <div id="levelup-modal" class="modal-overlay hidden">
        <div class="modal-content text-center level-up">
            <h2 class="text-5xl font-black text-red-400 mb-4">üéä NEXT STATION! üéä</h2>
            <p class="text-4xl font-bold text-white mb-6">
                <span class="subway-line" style="background-color: var(--subway-red); color: #fff;" id="new-level-badge">2</span>
                <span id="new-station-name">14th St</span>
            </p>
            <p class="text-2xl text-gray-300 mb-6">Station reached!</p>
            <div class="text-3xl font-bold mb-6 coin-icon">
                üí∞ +<span id="levelup-bonus">50</span> BONUS COINS
            </div>
            <button id="close-levelup-btn" class="btn btn-primary">Board Train</button>
        </div>
    </div>

    <!-- Store Modal -->
    <div id="store-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 900px; width: 95%;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-4xl font-black text-red-400">üè™ CONDUCTOR SHOP</h2>
                <div class="text-2xl font-bold coin-icon">üí∞ <span id="store-coin-count">0</span></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Left: Store Items -->
                <div>
                    <h3 class="text-2xl font-bold mb-4 text-white">Shop Items</h3>
                    <div id="store-items" class="space-y-3 max-h-96 overflow-y-auto"></div>
                </div>

                <!-- Right: Conductor Preview -->
                <div>
                    <h3 class="text-2xl font-bold mb-4 text-white">Your Conductor</h3>
                    <div class="conductor-container" id="store-conductor-preview">
                        <div class="conductor-hair"></div>
                        <div class="conductor-base"></div>
                        <div class="conductor-face">
                            <div class="conductor-eye conductor-eye-left"></div>
                            <div class="conductor-eye conductor-eye-right"></div>
                            <div class="conductor-smile"></div>
                        </div>
                        <div id="conductor-equipped-items"></div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-6">
                <button id="close-store-btn" class="btn btn-secondary">Close Shop</button>
            </div>
        </div>
    </div>

    <!-- Conductor Modal -->
    <div id="conductor-modal" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <h2 class="text-4xl font-black text-red-400 mb-6">üßë‚Äç‚úàÔ∏è MY CONDUCTOR</h2>
            <div class="conductor-container mx-auto mb-6" id="conductor-display">
                <div class="conductor-hair"></div>
                <div class="conductor-base"></div>
                <div class="conductor-face">
                    <div class="conductor-eye conductor-eye-left"></div>
                    <div class="conductor-eye conductor-eye-right"></div>
                    <div class="conductor-smile"></div>
                </div>
                <div id="conductor-items"></div>
            </div>
            <p class="text-gray-300 mb-4">Visit the store to customize your conductor!</p>
            <div class="flex justify-center gap-4">
                <button onclick="openStore()" class="btn btn-primary">Open Store</button>
                <button id="close-conductor-btn" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Subway Car Modal -->
    <div id="subwaycar-modal" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <h2 class="text-4xl font-black text-red-400 mb-6">üöá MY SUBWAY CAR</h2>
            <div class="mb-6">
                <div class="text-9xl mb-4" id="subwaycar-emoji">üöá</div>
                <div class="text-2xl font-bold text-white mb-2" id="subwaycar-name">Basic Subway Car</div>
                <div class="text-lg text-blue-400" id="subwaycar-capacity">Max Passengers: 30</div>
                <div class="text-md text-purple-400 mt-2">
                    <span class="text-xl">üë•</span>
                    <span id="subwaycar-current-passengers">12</span> /
                    <span id="subwaycar-max-capacity">30</span>
                </div>
            </div>
            <p class="text-gray-300 mb-4">Upgrade your subway car in the store to carry more passengers!</p>
            <div class="flex justify-center gap-4">
                <button onclick="openStore()" class="btn btn-primary">Open Store</button>
                <button id="close-subwaycar-btn" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Menu Modal -->
    <div id="menu-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 400px; width: 95%;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-black text-red-400">MENU</h2>
                <button onclick="toggleMenu()" class="text-3xl text-gray-400 hover:text-white">‚úï</button>
            </div>

            <div class="space-y-2">
                <div class="menu-item" onclick="toggleMenu(); setTimeout(openStore, 100);">
                    <div class="text-3xl">üè™</div>
                    <div>
                        <div class="text-lg font-bold text-white">Store</div>
                        <div class="text-xs text-gray-400">Buy items & upgrade your subway car</div>
                    </div>
                </div>

                <div class="menu-item" onclick="toggleMenu(); setTimeout(toggleConductor, 100);">
                    <div class="text-3xl">üßë‚Äç‚úàÔ∏è</div>
                    <div>
                        <div class="text-lg font-bold text-white">My Conductor</div>
                        <div class="text-xs text-gray-400">Customize your conductor</div>
                    </div>
                </div>

                <div class="menu-item" onclick="toggleMenu(); setTimeout(toggleSubwayCar, 100);">
                    <div class="text-3xl">üöá</div>
                    <div>
                        <div class="text-lg font-bold text-white">My Subway Car</div>
                        <div class="text-xs text-gray-400">View your current car</div>
                    </div>
                </div>

                <div class="menu-item" onclick="toggleMenu(); setTimeout(showStats, 100);">
                    <div class="text-3xl">üìä</div>
                    <div>
                        <div class="text-lg font-bold text-white">Stats & Progress</div>
                        <div class="text-xs text-gray-400">View your achievements</div>
                    </div>
                </div>

                <div class="menu-item" onclick="toggleMenu();">
                    <div class="text-3xl">üöÑ</div>
                    <div>
                        <div class="text-lg font-bold text-white">Express Mode</div>
                        <div class="text-xs text-gray-400">
                            <span id="multiplier-text">2x Coins Active!</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Station Arrival Cutscene -->
    <div id="station-cutscene" class="station-cutscene hidden">
        <div class="subway-doors" id="subway-doors">
            <div class="door door-left"></div>
            <div class="door door-right"></div>
            <div class="crowd">
                <div class="person"></div>
                <div class="person"></div>
                <div class="person"></div>
                <div class="person"></div>
                <div class="person"></div>
            </div>
            <div class="absolute top-8 w-full text-center">
                <h1 class="text-5xl font-black text-white mb-4" id="cutscene-station-name">42nd St</h1>
                <p class="text-2xl text-gray-200" id="cutscene-message">Stand clear of the closing doors!</p>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase Imports (Commented Out)
        // import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIG (Commented Out) ---
        /*
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { 
            apiKey: "YOUR_API_KEY", 
            authDomain: "YOUR_AUTH_DOMAIN", 
            projectId: "YOUR_PROJECT_ID" 
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- FIREBASE INITIALIZATION (Commented Out) ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        */

        // --- GLOBAL STATE & DOM ELEMENTS ---
        // let userId = null;
        let userProgress = {};
        let currentCategory = null;
        let currentShortcut = null;
        let quizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;

        // GAME MECHANICS
        let gameStats = {
            coins: 2890,
            distance: 0, // Changed from XP to distance (meters to next station)
            level: 6, // Start at 96th St
            multiplier: 1,
            startTime: Date.now(),
            expressUnlocked: false,
            ownedItems: ['car_express'], // Start with Express Car
            equippedItems: { subway: 'car_express' }, // Express Car equipped
            passengers: 0, // Start with no passengers
            maxPassengers: 140, // Express Car capacity
            masteredTopics: [] // Array of topic IDs that have been mastered (10/10 score)
        };

        const SUBWAY_STATIONS = [
            'Wall Street', '14th St', '34th St', '42nd St', '72nd St', '96th St', '110th St',
            '125th St', '140th St'
        ];

        const DISTANCE_PER_LEVEL = [100, 150, 200, 300, 400, 500, 700, 900, 1200, 1500, 2000, 2500, 3000, 4000, 5000];
        const COINS_PER_CORRECT = 10;
        const DISTANCE_PER_CORRECT = 15; // meters traveled per correct answer
        const EXPRESS_TIME = 0; // Auto-activate double coins immediately

        // STORE ITEMS
        const STORE_ITEMS = {
            hats: [
                { id: 'hat_basic', name: 'üé© Basic Cap', price: 50, emoji: 'üß¢', slot: 'hat' },
                { id: 'hat_conductor', name: 'üé© Conductor Hat', price: 150, emoji: 'üé©', slot: 'hat' },
                { id: 'hat_vintage', name: 'üéì Vintage Cap', price: 300, emoji: 'üéì', slot: 'hat' },
                { id: 'hat_crown', name: 'üëë Golden Crown', price: 1000, emoji: 'üëë', slot: 'hat' }
            ],
            accessories: [
                { id: 'acc_whistle', name: 'üé∫ Silver Whistle', price: 100, emoji: 'üé∫', slot: 'accessory' },
                { id: 'acc_badge', name: 'üèÖ Conductor Badge', price: 200, emoji: 'üèÖ', slot: 'accessory' },
                { id: 'acc_sunglasses', name: 'üï∂Ô∏è Cool Shades', price: 250, emoji: 'üï∂Ô∏è', slot: 'accessory' },
                { id: 'acc_medal', name: 'ü•á Gold Medal', price: 500, emoji: 'ü•á', slot: 'accessory' },
                { id: 'acc_diamond', name: 'üíé Diamond Ring', price: 2000, emoji: 'üíé', slot: 'accessory', requiresMastery: 1 },
                { id: 'acc_star', name: '‚≠ê Star Badge', price: 3000, emoji: '‚≠ê', slot: 'accessory', requiresMastery: 3 },
                { id: 'acc_trophy', name: 'üèÜ Master Trophy', price: 5000, emoji: 'üèÜ', slot: 'accessory', requiresMastery: 5 }
            ],
            subwayCar: [
                { id: 'car_clean', name: '‚ú® Clean Car', price: 300, emoji: '‚ú®', slot: 'subway', capacity: 40 },
                { id: 'car_modern', name: 'üöÑ Modern Car', price: 600, emoji: 'üöÑ', slot: 'subway', capacity: 55 },
                { id: 'car_luxury', name: 'üíé Luxury Car', price: 1500, emoji: 'üíé', slot: 'subway', capacity: 95 },
                { id: 'car_express', name: '‚ö° Express Car', price: 3000, emoji: '‚ö°', slot: 'subway', capacity: 140 },
                { id: 'car_mega', name: 'üöÄ Mega Car', price: 5000, emoji: 'üöÄ', slot: 'subway', capacity: 195 },
                { id: 'car_ultra', name: 'üåü Ultra Car', price: 8000, emoji: 'üåü', slot: 'subway', capacity: 265 },
                { id: 'car_supreme', name: 'üëë Supreme Car', price: 12000, emoji: 'üëë', slot: 'subway', capacity: 350 },
                { id: 'car_elite', name: 'üí´ Elite Car', price: 18000, emoji: 'üí´', slot: 'subway', capacity: 450 },
                { id: 'car_legendary', name: 'üèÜ Legendary Car', price: 30000, emoji: 'üèÜ', slot: 'subway', capacity: 575 }
            ]
        };

        const mainView = document.getElementById('main-view');
        const learnView = document.getElementById('learn-view');
        const quizView = document.getElementById('quiz-view');
        const categoryGrid = document.getElementById('category-grid');
        const shortcutGrid = document.getElementById('shortcut-grid');
        const reviewBtn = document.getElementById('review-btn');
        const backToCategoriesBtn = document.getElementById('back-to-categories-btn');
        const userInfo = document.getElementById('user-info');
        
        // --- MATH SHORTCUTS DATA ---
        const allShortcuts = {
            addition: {
                title: 'Addition Tips',
                shortcuts: {
                    add9: {
                        title: 'Adding 9',
                        explanation: 'To add 9, add 10 first and then subtract 1. For 67+9: think 67+10=77, then 77-1=76.',
                        generateQuestion: () => {
                            const n = Math.floor(Math.random() * 90) + 10;
                            return { question: `${n} + 9`, answer: n + 9 };
                        }
                    },
                    nearDoubles: {
                        title: 'Near Doubles',
                        explanation: 'If numbers are consecutive (like 47+48), double the smaller and add 1. For 47+48: think 47√ó2=94, then 94+1=95.',
                        generateQuestion: () => {
                            const n = Math.floor(Math.random() * 30) + 10;
                            return { question: `${n} + ${n+1}`, answer: n * 2 + 1 };
                        }
                    },
                    addInChunks: {
                        title: 'Left-to-Right Addition',
                        explanation: 'Add from left to right (Vedic style). For 47+38: add tens (40+30=70), then ones (7+8=15), then combine (70+15=85).',
                        generateQuestion: () => {
                            const t1 = (Math.floor(Math.random()*5)+2)*10;
                            const o1 = Math.floor(Math.random()*9)+1;
                            const t2 = (Math.floor(Math.random()*5)+2)*10;
                            const o2 = Math.floor(Math.random()*9)+1;
                            return { question: `${t1+o1} + ${t2+o2}`, answer: t1+o1+t2+o2 };
                        }
                    },
                    complement100: {
                        title: 'Complement to 100',
                        explanation: 'To add numbers near 100, use complements. For 97+88: take 97 to 100 (+3), then add remaining 85. Result: 100+85=185.',
                        generateQuestion: () => {
                            const n1 = Math.floor(Math.random() * 9) + 91; // 91-99
                            const n2 = Math.floor(Math.random() * 20) + 80; // 80-99
                            return { question: `${n1} + ${n2}`, answer: n1 + n2 };
                        }
                    },
                    addNear100: {
                        title: 'Adding Near Powers of 10',
                        explanation: 'For numbers near 100/1000, add the round number then adjust. For 156+99: think 156+100=256, then 256-1=255.',
                        generateQuestion: () => {
                            const n = Math.floor(Math.random() * 200) + 100;
                            const near = [99, 98, 999, 1001][Math.floor(Math.random()*4)];
                            return { question: `${n} + ${near}`, answer: n + near };
                        }
                    },
                }
            },
            subtraction: {
                title: 'Subtraction Tips',
                shortcuts: {
                    sub9: {
                        title: 'Subtracting 9',
                        explanation: 'To subtract 9, subtract 10 first then add 1 back. For 84-9: think 84-10=74, then 74+1=75.',
                        generateQuestion: () => {
                            const n = Math.floor(Math.random() * 90) + 20;
                            return { question: `${n} - 9`, answer: n - 9 };
                        }
                    },
                    nikhilam: {
                        title: 'Nikhilam (All from 9, Last from 10)',
                        explanation: 'For 1000-347: subtract each digit from 9 except the last from 10. (9-3=6, 9-4=5, 10-7=3). Answer: 653.',
                        generateQuestion: () => {
                            const n = Math.floor(Math.random() * 899) + 100;
                            return { question: `1000 - ${n}`, answer: 1000 - n };
                        }
                    },
                    constantDiff: {
                        title: 'Keep the Difference (Equidistance)',
                        explanation: 'Add or subtract the same amount from both numbers. For 63-47: add 3 to both ‚Üí 66-50=16.',
                        generateQuestion: () => {
                            const n2 = Math.floor(Math.random() * 40) + 40;
                            const n1 = n2 + Math.floor(Math.random()*25)+10;
                            return { question: `${n1} - ${n2}`, answer: n1-n2};
                        }
                    },
                    complementSub: {
                        title: 'Complement Subtraction',
                        explanation: 'For 150-87, find complement of 87 to 100 (which is 13), then add to 50. Result: 50+13=63.',
                        generateQuestion: () => {
                            const hundreds = Math.floor(Math.random() * 3) + 2;
                            const n1 = hundreds * 100 + Math.floor(Math.random() * 50);
                            const n2 = (hundreds-1) * 100 + Math.floor(Math.random() * 50) + 50;
                            return { question: `${n1} - ${n2}`, answer: n1 - n2 };
                        }
                    },
                    leftToRightSub: {
                        title: 'Left-to-Right Subtraction',
                        explanation: 'Subtract from left to right. For 156-82: first 100-80=20, then 56-2=54, then 20+54=74.',
                        generateQuestion: () => {
                            const n1 = Math.floor(Math.random() * 100) + 100;
                            const n2 = Math.floor(Math.random() * 50) + 30;
                            return { question: `${n1} - ${n2}`, answer: n1 - n2 };
                        }
                    },
                }
            },
            multiplication: {
                title: 'Multiplication Tips',
                shortcuts: {
                    squareEnding5: {
                        title: 'Squaring Numbers Ending in 5',
                        explanation: 'For 35¬≤: multiply first digit by next number (3√ó4=12), then append 25. Answer: 1225. For 85¬≤: 8√ó9=72, append 25 = 7225.',
                        generateQuestion: () => {
                            const n = Math.floor(Math.random() * 9) + 1;
                            const num = n * 10 + 5;
                            return { question: `${num}¬≤`, answer: num * num };
                        }
                    },
                    nikhilamMult: {
                        title: 'Nikhilam Multiplication (Near 100)',
                        explanation: 'For 97√ó96: both are near 100. Deficiencies: -3, -4. Cross-subtract: 97-4=93 (or 96-3). Multiply deficiencies: 3√ó4=12. Answer: 9312.',
                        generateQuestion: () => {
                            const n1 = Math.floor(Math.random() * 9) + 91;
                            const n2 = Math.floor(Math.random() * 9) + 91;
                            return { question: `${n1} √ó ${n2}`, answer: n1 * n2 };
                        }
                    },
                    verticalCrosswise: {
                        title: 'Vertically & Crosswise (2-Digit)',
                        explanation: 'For 23√ó14: Vertically (2√ó1=2, 3√ó4=12), Crosswise (2√ó4+3√ó1=11), combine: 2|11|12 = 2+1|1+1|2 = 322.',
                        generateQuestion: () => {
                            const n1 = Math.floor(Math.random() * 30) + 11;
                            const n2 = Math.floor(Math.random() * 30) + 11;
                            return { question: `${n1} √ó ${n2}`, answer: n1 * n2 };
                        }
                    },
                    mult11adv: {
                        title: 'Multiply by 11',
                        explanation: 'For 47√ó11: add digits (4+7=11), put sum in middle handling carry: 4|11|7 = 517. For 63√ó11: 6|9|3 = 693.',
                        generateQuestion: () => {
                            const tens = Math.floor(Math.random() * 8) + 1;
                            const ones = Math.floor(Math.random() * 9) + 1;
                            const num = tens * 10 + ones;
                            return { question: `${num} √ó 11`, answer: num * 11 };
                        }
                    },
                    mult12: {
                        title: 'Multiply by 12',
                        explanation: 'To multiply by 12, multiply by 10, then add the number doubled. For 34√ó12: 340 + 68 = 408.',
                        generateQuestion: () => {
                            const n = Math.floor(Math.random() * 30) + 10;
                            return { question: `${n} √ó 12`, answer: n * 12 };
                        }
                    },
                    multBy25: {
                        title: 'Multiply by 25',
                        explanation: 'For 36√ó25: divide by 4 (36√∑4=9), then multiply by 100. Answer: 900. Works best with multiples of 4.',
                        generateQuestion: () => {
                            const n = (Math.floor(Math.random()*15)+2)*4;
                            return { question: `${n} √ó 25`, answer: n * 25 };
                        }
                    },
                    baseMult: {
                        title: 'Base Method Multiplication',
                        explanation: 'For 43√ó48 (near 50): Excesses: +3, -2. Cross-add: 43-2=41, append product: 3√ó-2=-6 (borrow). Answer: 40|56 = 2064.',
                        generateQuestion: () => {
                            const n1 = Math.floor(Math.random() * 15) + 40;
                            const n2 = Math.floor(Math.random() * 15) + 40;
                            return { question: `${n1} √ó ${n2}`, answer: n1 * n2 };
                        }
                    },
                    squareNear50: {
                        title: 'Squaring Near 50',
                        explanation: 'For 53¬≤: excess is 3. Left: 25+3=28, Right: 3¬≤=09. Answer: 2809. For 47¬≤: deficit -3, Left: 25-3=22, Right: 3¬≤=09 = 2209.',
                        generateQuestion: () => {
                            const excess = Math.floor(Math.random() * 10) - 5;
                            const num = 50 + excess;
                            return { question: `${num}¬≤`, answer: num * num };
                        }
                    },
                }
            },
            division: {
                title: 'Division Tips',
                shortcuts: {
                    divBy5: {
                        title: 'Divide by 5',
                        explanation: 'To divide by 5, multiply by 2 and divide by 10. For 340√∑5: 340√ó2=680, then 680√∑10=68.',
                        generateQuestion: () => {
                            const n = (Math.floor(Math.random()*40)+10)*5;
                            return { question: `${n} √∑ 5`, answer: n / 5 };
                        }
                    },
                    divBy9: {
                        title: 'Division by 9 (Digit Sum)',
                        explanation: 'For 234√∑9: sum digits (2+3+4=9), divisible! To find quotient, use pattern: 234‚âà9√ó26. Check: 9√ó26=234.',
                        generateQuestion: () => {
                            const ans = Math.floor(Math.random()*30)+10;
                            const n = ans * 9;
                            return { question: `${n} √∑ 9`, answer: ans };
                        }
                    },
                    ekadhikena: {
                        title: 'Ekadhikena (One More Than Previous)',
                        explanation: 'For 1√∑19: divisor 19, one more than previous digit: 1+1=2. Pattern: 0.052631... For simple cases like 4√∑19‚âà0.21.',
                        generateQuestion: () => {
                            const quotient = Math.floor(Math.random()*9)+1;
                            const n = quotient * 19;
                            return { question: `${n} √∑ 19`, answer: quotient };
                        }
                    },
                    divBy4: {
                        title: 'Divide by 4',
                        explanation: 'Halve the number twice. For 144√∑4: first 144√∑2=72, then 72√∑2=36.',
                        generateQuestion: () => {
                            const n = (Math.floor(Math.random()*30)+5)*4;
                            return { question: `${n} √∑ 4`, answer: n / 4 };
                        }
                    },
                    divBy8: {
                        title: 'Divide by 8',
                        explanation: 'Halve the number three times. For 128√∑8: 128√∑2=64, 64√∑2=32, 32√∑2=16.',
                        generateQuestion: () => {
                            const n = (Math.floor(Math.random()*20)+5)*8;
                            return { question: `${n} √∑ 8`, answer: n / 8 };
                        }
                    },
                    divBy11: {
                        title: 'Divisibility by 11',
                        explanation: 'Alternating sum of digits must be divisible by 11. For 121: 1-2+1=0 (divisible). For 253: 2-5+3=0 (yes!).',
                        generateQuestion: () => {
                            const ans = Math.floor(Math.random()*20)+5;
                            const n = ans * 11;
                            return { question: `${n} √∑ 11`, answer: ans };
                        }
                    },
                    paravartya: {
                        title: 'Paravartya (Transpose & Adjust)',
                        explanation: 'For division by numbers with last digit 9, use complement. 1√∑19: use 2 (20-19+1). Advanced technique for complex divisions.',
                        generateQuestion: () => {
                            const divisor = [29, 39, 49, 19][Math.floor(Math.random()*4)];
                            const quotient = Math.floor(Math.random()*5)+2;
                            const n = quotient * divisor;
                            return { question: `${n} √∑ ${divisor}`, answer: quotient };
                        }
                    },
                    ruleFor3: {
                        title: 'Divisibility by 3',
                        explanation: 'Sum all digits. If sum is divisible by 3, so is the number. For 147: 1+4+7=12, 12√∑3=4, so 147√∑3 works!',
                        generateQuestion: () => {
                            const ans = Math.floor(Math.random()*50)+10;
                            const n = ans * 3;
                            return { question: `${n} √∑ 3`, answer: ans };
                        }
                    },
                }
            }
        };
        
        // --- FIREBASE AUTHENTICATION & DATA HANDLING (Commented Out) ---
        /*
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userInfo.textContent = `User ID: ${userId}`;
                await setupUserListener();
            }
        });
        
        async function authenticateUser() {
            try {
                // Defaulting to Anonymous Sign-in as requested.
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Authentication failed:", error);
                userInfo.innerHTML = `<span class="text-red-600 font-semibold">Could not save progress.</span> Please ensure Anonymous Sign-in is enabled in your Firebase project's settings.`;
            }
        }
        
        async function setupUserListener() {
            if (!userId) return;
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/mathShortcutsProgress/data`);
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    userProgress = docSnap.data();
                } else {
                    // Initialize progress for new nested structure
                    userProgress = {};
                    for (const catKey in allShortcuts) {
                        userProgress[catKey] = {};
                        for (const shortKey in allShortcuts[catKey].shortcuts) {
                            userProgress[catKey][shortKey] = { strength: 0, lastReviewed: null };
                        }
                    }
                    saveProgress();
                }
                renderCategories();
            }, (error) => {
                console.error("Error listening to progress:", error);
            });
        }
        
        async function saveProgress() {
            if (!userId) return;
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/mathShortcutsProgress/data`);
            try {
                await setDoc(docRef, userProgress);
            } catch (error) {
                console.error("Error saving progress: ", error);
            }
        }
        */

        // --- LOCAL STORAGE HANDLING ---
        const STORAGE_KEY = 'subwayMathExpress_progress';
        const STATS_KEY = 'subwayMathExpress_stats';

        function initializeLocalProgress() {
            // Try to load from localStorage first
            const savedProgress = localStorage.getItem(STORAGE_KEY);
            const savedStats = localStorage.getItem(STATS_KEY);

            if (savedProgress) {
                // Load existing progress
                try {
                    userProgress = JSON.parse(savedProgress);
                    console.log("‚úÖ Progress loaded from localStorage");
                } catch (e) {
                    console.error("Error loading progress:", e);
                    createEmptyProgress();
                }
            } else {
                createEmptyProgress();
            }

            if (savedStats) {
                // Load existing game stats
                try {
                    const loaded = JSON.parse(savedStats);
                    gameStats.coins = loaded.coins !== undefined ? loaded.coins : gameStats.coins;
                    gameStats.distance = loaded.distance !== undefined ? loaded.distance : (loaded.xp || gameStats.distance); // Support old XP or new distance
                    gameStats.level = loaded.level !== undefined ? loaded.level : gameStats.level;
                    gameStats.multiplier = loaded.multiplier !== undefined ? loaded.multiplier : gameStats.multiplier;
                    gameStats.expressUnlocked = loaded.expressUnlocked !== undefined ? loaded.expressUnlocked : gameStats.expressUnlocked;
                    gameStats.ownedItems = loaded.ownedItems !== undefined ? loaded.ownedItems : gameStats.ownedItems;
                    gameStats.equippedItems = loaded.equippedItems !== undefined ? loaded.equippedItems : gameStats.equippedItems;
                    gameStats.passengers = loaded.passengers !== undefined ? loaded.passengers : gameStats.passengers;
                    gameStats.maxPassengers = loaded.maxPassengers !== undefined ? loaded.maxPassengers : gameStats.maxPassengers;
                    gameStats.masteredTopics = loaded.masteredTopics !== undefined ? loaded.masteredTopics : gameStats.masteredTopics;
                    console.log("‚úÖ Game stats loaded from localStorage");
                } catch (e) {
                    console.error("Error loading stats:", e);
                }
            }

            // Reset start time (don't save this)
            gameStats.startTime = Date.now();

            // Update UI with controls
            const hasProgress = savedProgress || savedStats;
            const welcomeMsg = hasProgress
                ? `<span class="text-green-400">üíæ Progress auto-saved!</span>`
                : `<span class="text-yellow-400">üéÆ New game started!</span>`;

            userInfo.innerHTML = `
                ${welcomeMsg}
                <button onclick="exportProgress()" class="ml-3 text-blue-400 hover:text-blue-300 underline">üì§ Export</button>
                <button onclick="importProgress()" class="ml-3 text-green-400 hover:text-green-300 underline">üì• Import</button>
                <button onclick="resetProgress()" class="ml-3 text-red-400 hover:text-red-300 underline">üóëÔ∏è Reset</button>
            `;

            // Apply equipped subway car capacity if one is equipped
            const equippedCarId = gameStats.equippedItems['subway'];
            if (equippedCarId) {
                const allItems = Object.values(STORE_ITEMS).flat();
                const equippedCar = allItems.find(i => i.id === equippedCarId);
                if (equippedCar && equippedCar.capacity) {
                    gameStats.maxPassengers = equippedCar.capacity;
                    console.log(`‚úÖ Equipped subway car capacity applied: ${equippedCar.capacity}`);
                }
            }

            renderCategories();
            updateGameStats();
        }

        function createEmptyProgress() {
            userProgress = {};
            for (const catKey in allShortcuts) {
                userProgress[catKey] = {};
                for (const shortKey in allShortcuts[catKey].shortcuts) {
                    userProgress[catKey][shortKey] = { strength: 0, lastReviewed: null };
                }
            }
        }

        function saveProgress() {
            try {
                // Save user progress (mastery levels)
                localStorage.setItem(STORAGE_KEY, JSON.stringify(userProgress));

                // Save game stats (coins, distance, level, store items, passengers)
                const statsToSave = {
                    coins: gameStats.coins,
                    distance: gameStats.distance,
                    level: gameStats.level,
                    multiplier: gameStats.multiplier,
                    expressUnlocked: gameStats.expressUnlocked,
                    ownedItems: gameStats.ownedItems,
                    equippedItems: gameStats.equippedItems,
                    passengers: gameStats.passengers,
                    maxPassengers: gameStats.maxPassengers,
                    masteredTopics: gameStats.masteredTopics
                };
                localStorage.setItem(STATS_KEY, JSON.stringify(statsToSave));

                console.log("üíæ Progress saved to localStorage");
            } catch (e) {
                console.error("Error saving progress:", e);
                userInfo.innerHTML = `<span class="text-red-400">‚ö†Ô∏è Could not save progress (storage full?)</span>`;
            }
        }

        // Reset all progress
        function resetProgress() {
            if (confirm("üö® Are you sure? This will delete ALL your coins, XP, and progress!")) {
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem(STATS_KEY);
                location.reload(); // Reload page to reset everything
            }
        }

        // Export progress to file
        function exportProgress() {
            try {
                const exportData = {
                    version: 3, // Incremented for new format with passengers
                    timestamp: new Date().toISOString(),
                    progress: userProgress,
                    stats: {
                        coins: gameStats.coins,
                        distance: gameStats.distance,
                        level: gameStats.level,
                        multiplier: gameStats.multiplier,
                        expressUnlocked: gameStats.expressUnlocked,
                        ownedItems: gameStats.ownedItems,
                        equippedItems: gameStats.equippedItems,
                        passengers: gameStats.passengers,
                        maxPassengers: gameStats.maxPassengers
                    }
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `subway-math-backup-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);

                alert("‚úÖ Progress exported! Save this file to backup your progress.");
            } catch (e) {
                console.error("Export error:", e);
                alert("‚ùå Failed to export progress.");
            }
        }

        // Import progress from file
        function importProgress() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importData = JSON.parse(event.target.result);

                        // Validate data structure
                        if (!importData.progress || !importData.stats) {
                            throw new Error("Invalid backup file format");
                        }

                        // Confirm before overwriting
                        if (confirm("‚ö†Ô∏è This will overwrite your current progress. Continue?")) {
                            // Save imported data
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(importData.progress));
                            localStorage.setItem(STATS_KEY, JSON.stringify(importData.stats));

                            alert("‚úÖ Progress imported successfully! Reloading...");
                            location.reload();
                        }
                    } catch (e) {
                        console.error("Import error:", e);
                        alert("‚ùå Failed to import: Invalid file format.");
                    }
                };
                reader.readAsText(file);
            };

            input.click();
        }

        // Make functions available globally
        window.resetProgress = resetProgress;
        window.exportProgress = exportProgress;
        window.importProgress = importProgress;

        // --- STORE FUNCTIONS ---
        function openStore() {
            document.getElementById('store-modal').classList.remove('hidden');
            document.getElementById('store-coin-count').textContent = gameStats.coins;
            renderStoreItems();
            renderConductorPreview();
        }

        function renderStoreItems() {
            const container = document.getElementById('store-items');
            container.innerHTML = '';

            Object.values(STORE_ITEMS).flat().forEach(item => {
                const owned = gameStats.ownedItems.includes(item.id);
                const equipped = gameStats.equippedItems[item.slot] === item.id;
                const canAfford = gameStats.coins >= item.price;
                const masteryMet = !item.requiresMastery || gameStats.masteredTopics.length >= item.requiresMastery;

                const itemEl = document.createElement('div');
                itemEl.className = `store-item ${owned ? 'owned' : ''} ${equipped ? 'equipped' : ''}`;
                const emojiSize = item.slot === 'subway' ? 'text-5xl' : 'text-2xl';
                itemEl.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="${emojiSize} mb-1">${item.emoji}</div>
                            <div class="text-white font-bold">${item.name}</div>
                            <div class="text-sm text-gray-400">${owned ? (equipped ? 'Equipped' : 'Owned') : `${item.price} coins`}</div>
                            ${item.capacity ? `<div class="text-xs text-blue-400">Max Passengers: ${item.capacity}</div>` : ''}
                            ${item.requiresMastery ? `<div class="text-xs ${masteryMet ? 'text-purple-400' : 'text-red-400'}">üèÜ Requires ${item.requiresMastery} Mastered Topic${item.requiresMastery > 1 ? 's' : ''}</div>` : ''}
                        </div>
                        <div>
                            ${!owned && canAfford && masteryMet ? `<button onclick="purchaseItem('${item.id}')" class="btn btn-primary text-sm px-3 py-1">Buy</button>` : ''}
                            ${!owned && (!canAfford || !masteryMet) ? `<span class="text-gray-500 text-xs">${!masteryMet ? 'Locked' : 'Need more coins'}</span>` : ''}
                            ${owned && !equipped ? `<button onclick="equipItem('${item.id}')" class="btn btn-secondary text-sm px-3 py-1">Equip</button>` : ''}
                            ${equipped ? '<span class="text-yellow-400 text-sm">‚úì Equipped</span>' : ''}
                        </div>
                    </div>
                `;
                container.appendChild(itemEl);
            });
        }

        function purchaseItem(itemId) {
            const allItems = Object.values(STORE_ITEMS).flat();
            const item = allItems.find(i => i.id === itemId);

            if (!item || gameStats.coins < item.price) {
                alert("‚ùå Not enough coins!");
                return;
            }

            if (gameStats.ownedItems.includes(itemId)) {
                alert("‚úÖ You already own this item!");
                return;
            }

            gameStats.coins -= item.price;
            gameStats.ownedItems.push(itemId);
            saveProgress();
            renderStoreItems();
            updateGameStats();
            alert(`‚úÖ Purchased ${item.name}!`);
        }

        function equipItem(itemId) {
            const allItems = Object.values(STORE_ITEMS).flat();
            const item = allItems.find(i => i.id === itemId);

            if (!item || !gameStats.ownedItems.includes(itemId)) {
                return;
            }

            gameStats.equippedItems[item.slot] = itemId;

            // If equipping a subway car, update max passengers and add some passengers
            if (item.slot === 'subway' && item.capacity) {
                gameStats.maxPassengers = item.capacity;
                // Add some passengers when upgrading (50% of new capacity or current, whichever is higher)
                gameStats.passengers = Math.max(gameStats.passengers, Math.floor(item.capacity * 0.5));
                updateGameStats();
            }

            saveProgress();
            renderStoreItems();
            renderConductorPreview();
        }

        function renderConductorPreview() {
            const container = document.getElementById('conductor-equipped-items');
            container.innerHTML = '';

            const allItems = Object.values(STORE_ITEMS).flat();
            Object.entries(gameStats.equippedItems).forEach(([slot, itemId]) => {
                const item = allItems.find(i => i.id === itemId);
                if (item) {
                    const itemEl = document.createElement('div');
                    itemEl.className = `conductor-item ${slot}-slot`;
                    itemEl.style.cssText = slot === 'hat' ? 'top: -5px; left: 50%; transform: translateX(-50%);' :
                                          slot === 'accessory' ? 'top: 35px; left: 50%; transform: translateX(-50%);' :
                                          'bottom: 10px; left: 50%; transform: translateX(-50%);';
                    itemEl.textContent = item.emoji;
                    container.appendChild(itemEl);
                }
            });
        }

        function toggleConductor() {
            const modal = document.getElementById('conductor-modal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) {
                renderConductor();
            }
        }

        function toggleSubwayCar() {
            const modal = document.getElementById('subwaycar-modal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) {
                renderSubwayCar();
            }
        }

        function toggleMenu() {
            const modal = document.getElementById('menu-modal');
            modal.classList.toggle('hidden');
        }

        function showStats() {
            const masteredCount = gameStats.masteredTopics.length;
            const totalCoins = gameStats.coins;
            const currentLevel = gameStats.level;
            const stationName = SUBWAY_STATIONS[gameStats.level - 1] || 'Final Stop';

            alert(`üìä YOUR STATS\n\nüí∞ Total Coins: ${totalCoins}\nüöá Current Station: ${stationName}\nüèÜ Mastered Topics: ${masteredCount}\nüë• Passengers: ${gameStats.passengers}/${gameStats.maxPassengers}`);
        }

        function renderSubwayCar() {
            // Find equipped subway car
            const allItems = Object.values(STORE_ITEMS).flat();
            const equippedCarId = gameStats.equippedItems.subway;
            const equippedCar = allItems.find(i => i.id === equippedCarId);

            if (equippedCar) {
                document.getElementById('subwaycar-emoji').textContent = equippedCar.emoji;
                document.getElementById('subwaycar-name').textContent = equippedCar.name;
                document.getElementById('subwaycar-capacity').textContent = `Max Passengers: ${equippedCar.capacity}`;
            } else {
                document.getElementById('subwaycar-emoji').textContent = 'üöá';
                document.getElementById('subwaycar-name').textContent = 'Basic Subway Car';
                document.getElementById('subwaycar-capacity').textContent = `Max Passengers: ${gameStats.maxPassengers}`;
            }

            document.getElementById('subwaycar-current-passengers').textContent = gameStats.passengers;
            document.getElementById('subwaycar-max-capacity').textContent = gameStats.maxPassengers;
        }

        function renderConductor() {
            const container = document.getElementById('conductor-items');
            container.innerHTML = '';

            const allItems = Object.values(STORE_ITEMS).flat();
            Object.entries(gameStats.equippedItems).forEach(([slot, itemId]) => {
                const item = allItems.find(i => i.id === itemId);
                if (item) {
                    const itemEl = document.createElement('div');
                    itemEl.className = `conductor-item ${slot}-slot`;
                    itemEl.style.cssText = slot === 'hat' ? 'top: -5px; left: 50%; transform: translateX(-50%);' :
                                          slot === 'accessory' ? 'top: 35px; left: 50%; transform: translateX(-50%);' :
                                          'bottom: 10px; left: 50%; transform: translateX(-50%);';
                    itemEl.textContent = item.emoji;
                    container.appendChild(itemEl);
                }
            });
        }

        // Station cutscene animation
        function playStationCutscene(stationName) {
            return new Promise((resolve) => {
                const cutscene = document.getElementById('station-cutscene');
                const doors = document.getElementById('subway-doors');
                document.getElementById('cutscene-station-name').textContent = stationName;
                document.getElementById('cutscene-message').textContent = 'Now arriving at...';

                cutscene.classList.remove('hidden');

                // Play ding-dong sound (placeholder - would need actual audio)
                console.log('üîî Ding-dong!');

                setTimeout(() => {
                    doors.classList.add('doors-open');
                    document.getElementById('cutscene-message').textContent = 'Stand clear of the closing doors!';
                }, 1000);

                setTimeout(() => {
                    doors.classList.remove('doors-open');
                }, 3000);

                setTimeout(() => {
                    cutscene.classList.add('hidden');
                    resolve();
                }, 4500);
            });
        }

        // Make store functions globally available
        window.openStore = openStore;
        window.purchaseItem = purchaseItem;
        window.equipItem = equipItem;
        window.toggleConductor = toggleConductor;
        window.toggleSubwayCar = toggleSubwayCar;

        // Word problem checker function
        function checkWordProblem(problemId, correctAnswer, explanation) {
            const inputEl = document.getElementById(`${problemId}-input`);
            const feedbackEl = document.getElementById(`${problemId}-feedback`);
            const userAnswer = parseInt(inputEl.value, 10);

            if (isNaN(userAnswer)) {
                feedbackEl.className = 'ml-12 bg-yellow-900/30 border-l-4 border-yellow-400 p-3 rounded mt-2';
                feedbackEl.innerHTML = '<span class="text-yellow-400">‚ö†Ô∏è Please enter a number!</span>';
                feedbackEl.classList.remove('hidden');
                return;
            }

            if (userAnswer === correctAnswer) {
                feedbackEl.className = 'ml-12 bg-green-900/30 border-l-4 border-green-400 p-3 rounded mt-2';
                feedbackEl.innerHTML = '<span class="text-green-400 text-lg font-bold">‚úÖ Correct! Great job!</span>';
            } else {
                feedbackEl.className = 'ml-12 bg-red-900/30 border-l-4 border-red-400 p-4 rounded mt-2';
                feedbackEl.innerHTML = `
                    <div class="text-red-400 text-lg font-bold mb-2">‚ùå Not quite. The correct answer is ${correctAnswer}</div>
                    <div class="text-gray-300 text-base">${explanation}</div>
                `;
            }
            feedbackEl.classList.remove('hidden');
        }
        window.checkWordProblem = checkWordProblem;

        // Practice problem checker function
        function checkPractice(practiceId, correctAnswer) {
            const inputEl = document.getElementById(`${practiceId}-input`);
            const feedbackEl = document.getElementById(`${practiceId}-feedback`);
            const userAnswer = parseInt(inputEl.value, 10);

            if (isNaN(userAnswer)) {
                feedbackEl.className = 'bg-yellow-900/30 border-l-4 border-yellow-400 p-3 rounded mt-2';
                feedbackEl.innerHTML = '<span class="text-yellow-400">‚ö†Ô∏è Please enter a number!</span>';
                feedbackEl.classList.remove('hidden');
                return;
            }

            if (userAnswer === correctAnswer) {
                feedbackEl.className = 'bg-green-900/30 border-l-4 border-green-400 p-3 rounded mt-2';
                feedbackEl.innerHTML = '<span class="text-green-400 text-lg font-bold">‚úÖ Correct! Well done!</span>';
            } else {
                feedbackEl.className = 'bg-blue-900/30 border-l-4 border-blue-400 p-4 rounded mt-2';
                feedbackEl.innerHTML = `
                    <div class="text-blue-400 text-lg font-bold mb-2">üìù The answer is ${correctAnswer}</div>
                    <div class="text-gray-300 text-base">Try solving it again using the technique explained above!</div>
                `;
            }
            feedbackEl.classList.remove('hidden');
        }
        window.checkPractice = checkPractice;

        // --- GAME MECHANICS FUNCTIONS ---
        function updateGameStats() {
            document.getElementById('coin-count').textContent = gameStats.coins;
            document.getElementById('level-badge').textContent = '2'; // Always show 2 train (red line)
            document.getElementById('station-name').textContent = SUBWAY_STATIONS[gameStats.level - 1] || 'Final Stop';
            document.getElementById('multiplier').textContent = gameStats.multiplier + 'x';

            // Update distance/progress to next station
            const distanceNeeded = DISTANCE_PER_LEVEL[gameStats.level - 1] || 5000;
            const distanceProgress = (gameStats.distance / distanceNeeded) * 100;

            // Update train position on track
            const trainEl = document.getElementById('train-position');
            if (trainEl) {
                trainEl.style.left = Math.min(distanceProgress, 100) + '%';
            }

            document.getElementById('distance-current').textContent = gameStats.distance;
            document.getElementById('distance-needed').textContent = distanceNeeded;

            // Update distance progress bar
            const distanceBar = document.getElementById('distance-progress');
            if (distanceBar) {
                distanceBar.style.width = Math.min(distanceProgress, 100) + '%';
            }

            // Update passenger count
            document.getElementById('passenger-count').textContent = gameStats.passengers;
            document.getElementById('max-passengers').textContent = gameStats.maxPassengers;
            const passengerProgress = (gameStats.passengers / gameStats.maxPassengers) * 100;
            const passengerBar = document.getElementById('passenger-progress');
            if (passengerBar) {
                passengerBar.style.width = passengerProgress + '%';
            }

            // Check for express train
            checkExpressTrain();
        }

        function awardCoins(amount) {
            const coins = amount * gameStats.multiplier;
            gameStats.coins += coins;
            updateGameStats();
            showCoinAnimation(coins);
            saveProgress(); // Auto-save
            return coins;
        }

        function awardDistance(amount) {
            gameStats.distance += amount;
            const distanceNeeded = DISTANCE_PER_LEVEL[gameStats.level - 1] || 5000;

            if (gameStats.distance >= distanceNeeded) {
                gameStats.distance -= distanceNeeded;
                levelUp();
            }
            updateGameStats();
            saveProgress(); // Auto-save
        }

        function showCoinAnimation(amount) {
            const container = document.getElementById('coin-animation-container');
            const coinEl = document.createElement('div');
            coinEl.className = 'coin-float text-4xl font-bold coin-icon absolute';
            coinEl.textContent = '+' + amount + ' üí∞';
            container.appendChild(coinEl);

            setTimeout(() => {
                container.removeChild(coinEl);
            }, 1000);
        }

        async function levelUp() {
            gameStats.level++;
            const bonus = gameStats.level * 50;
            gameStats.coins += bonus;
            const newStation = SUBWAY_STATIONS[gameStats.level - 1] || 'Final Stop';

            // Random passengers leave at each station (10-30% of current passengers)
            if (gameStats.passengers > 0) {
                const leavePercentage = 0.10 + (Math.random() * 0.20); // 10-30%
                const passengersLeaving = Math.floor(gameStats.passengers * leavePercentage);
                gameStats.passengers = Math.max(0, gameStats.passengers - passengersLeaving);
            }

            // Play station cutscene animation
            await playStationCutscene(newStation);

            // Show level up modal
            document.getElementById('new-level-badge').textContent = '2'; // Always show 2 train (red line)
            document.getElementById('new-station-name').textContent = newStation;
            document.getElementById('levelup-bonus').textContent = bonus;
            document.getElementById('levelup-modal').classList.remove('hidden');
            saveProgress(); // Auto-save
        }

        function checkExpressTrain() {
            const elapsed = Date.now() - gameStats.startTime;
            if (!gameStats.expressUnlocked && elapsed >= EXPRESS_TIME) {
                gameStats.expressUnlocked = true;
                gameStats.multiplier = 2;
                document.getElementById('express-modal').classList.remove('hidden');
                document.getElementById('express-status').textContent = 'DOUBLE COINS ACTIVE!';
                document.getElementById('express-card').classList.add('pulse-glow');
                updateGameStats(); // Update display
                saveProgress(); // Auto-save
            } else if (!gameStats.expressUnlocked) {
                const remaining = Math.ceil((EXPRESS_TIME - elapsed) / 1000);
                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;
                document.getElementById('express-status').textContent = `${minutes}:${seconds.toString().padStart(2, '0')} TO DOUBLE COINS`;
            }
        }

        // Update express timer every second
        setInterval(checkExpressTrain, 1000);
        
        // --- VIEW RENDERING & SWITCHING ---
        function switchView(view) {
            mainView.classList.add('hidden');
            learnView.classList.add('hidden');
            quizView.classList.add('hidden');
            document.getElementById(view).classList.remove('hidden');
        }

        function renderCategories() {
            currentCategory = null;
            categoryGrid.innerHTML = '';
            categoryGrid.classList.remove('hidden');
            document.getElementById('shortcut-grid-wrapper').classList.add('hidden');
            backToCategoriesBtn.classList.add('hidden');
            reviewBtn.classList.remove('hidden');

            const colors = ['var(--subway-red)', 'var(--subway-orange)', 'var(--subway-blue)', 'var(--subway-green)'];
            const lines = ['‚ûï', '‚ûñ', '‚úñÔ∏è', '‚ûó'];

            Object.entries(allShortcuts).forEach(([key, category], index) => {
                const card = document.createElement('div');
                card.className = 'card p-8 cursor-pointer text-center';
                card.dataset.category = key;
                card.innerHTML = `
                    <div class="text-6xl mb-4">
                        ${lines[index]}
                    </div>
                    <h2 class="text-3xl font-bold text-white">${category.title}</h2>
                `;
                card.addEventListener('click', () => renderShortcutGrid(key));
                categoryGrid.appendChild(card);
            });
        }

        function renderShortcutGrid(categoryKey) {
            currentCategory = categoryKey;
            const shortcutGrid = document.getElementById('shortcut-grid');
            shortcutGrid.innerHTML = '';
            categoryGrid.classList.add('hidden');
            document.getElementById('shortcut-grid-wrapper').classList.remove('hidden');
            backToCategoriesBtn.classList.remove('hidden');
            reviewBtn.classList.add('hidden');

            const category = allShortcuts[categoryKey];
            document.getElementById('category-title').textContent = category.title;

            Object.entries(category.shortcuts).forEach(([key, shortcut]) => {
                const progress = userProgress[categoryKey]?.[key] || { strength: 0 };
                const strength = progress.strength || 0;
                const card = document.createElement('div');
                card.className = 'card p-6 cursor-pointer';
                card.dataset.shortcut = key;
                card.innerHTML = `
                    <h3 class="text-xl font-bold text-white mb-3">${shortcut.title}</h3>
                    <div class="progress-bar-bg w-full mb-2">
                        <div class="progress-bar" style="width: ${strength * 20}%"></div>
                    </div>
                    <span class="text-sm text-gray-400 mt-1 block">Mastery: ${strength}/5</span>
                `;
                card.addEventListener('click', () => showLearnView(categoryKey, key));
                shortcutGrid.appendChild(card);
            });
        }

        // Helper function to generate subway word problems
        function generateSubwayWordProblem(categoryKey, shortcutKey) {
            const problems = {
                addition: [
                    {question: "üöá Train A has {n1} passengers. At the next stop, {n2} more people board. How many passengers total?", type: "add", explanation: "When people board the train, we ADD them. So {n1} + {n2} = {answer}"},
                    {question: "üé´ You bought a MetroCard with ${n1} on it. You add ${n2} more. How much is on your card now?", type: "add", explanation: "Adding money to your card means addition: ${n1} + ${n2} = ${answer}"},
                    {question: "üë• There are {n1} people waiting at 42nd St and {n2} people at Times Square. How many total?", type: "add", explanation: "To find the total, we ADD both groups: {n1} + {n2} = {answer}"}
                ],
                subtraction: [
                    {question: "üöá A train starts with {n1} passengers. {n2} people get off at the next stop. How many remain?", type: "sub", explanation: "When people get off, we SUBTRACT them: {n1} - {n2} = {answer}"},
                    {question: "üé´ You have ${n1} on your MetroCard. A ride costs ${n2}. How much is left?", type: "sub", explanation: "After spending money, SUBTRACT the cost: ${n1} - ${n2} = ${answer}"},
                    {question: "‚è±Ô∏è The train takes {n1} minutes to reach the last stop. It's been {n2} minutes. How much longer?", type: "sub", explanation: "To find remaining time, SUBTRACT what's passed: {n1} - {n2} = {answer} minutes left"}
                ],
                multiplication: [
                    {question: "üöá Each subway car holds {n1} people. There are {n2} cars. What's the total capacity?", type: "mult", explanation: "MULTIPLY the number per car by total cars: {n1} √ó {n2} = {answer}"},
                    {question: "üé´ A MetroCard costs ${n1}. You buy {n2} of them. What's the total cost?", type: "mult", explanation: "MULTIPLY the cost by quantity: ${n1} √ó {n2} = ${answer}"},
                    {question: "üë®‚Äç‚úàÔ∏è Each conductor works {n1} hours per day for {n2} days. How many total hours?", type: "mult", explanation: "MULTIPLY hours per day by number of days: {n1} √ó {n2} = {answer} hours"}
                ],
                division: [
                    {question: "üöá {n1} passengers need to fit into {n2} subway cars equally. How many per car?", type: "div", explanation: "DIVIDE total passengers by number of cars: {n1} √∑ {n2} = {answer} per car"},
                    {question: "üé´ ${n1} is split equally among {n2} MetroCards. How much on each card?", type: "div", explanation: "DIVIDE the total amount by number of cards: ${n1} √∑ {n2} = ${answer} per card"},
                    {question: "‚è±Ô∏è A {n1} minute journey is divided into {n2} equal stops. How long between stops?", type: "div", explanation: "DIVIDE total time by number of stops: {n1} √∑ {n2} = {answer} minutes between stops"}
                ]
            };

            const categoryProblems = problems[categoryKey] || problems.addition;
            const template = categoryProblems[Math.floor(Math.random() * categoryProblems.length)];
            const shortcut = allShortcuts[categoryKey].shortcuts[shortcutKey];
            const ex = shortcut.generateQuestion();

            // Extract numbers from the question
            const numbers = ex.question.match(/\d+/g) || ['10', '5'];
            const n1 = numbers[0] || '10';
            const n2 = numbers[1] || '5';

            const problemText = template.question.replace('{n1}', n1).replace('{n2}', n2);
            const explanationText = template.explanation
                .replace(/{n1}/g, n1)
                .replace(/{n2}/g, n2)
                .replace(/{answer}/g, ex.answer);

            return {question: problemText, answer: ex.answer, explanation: explanationText};
        }

        // Helper function to generate step-by-step breakdown
        function generateStepByStep(categoryKey, shortcutKey) {
            const shortcut = allShortcuts[categoryKey].shortcuts[shortcutKey];
            const ex = shortcut.generateQuestion();
            const steps = [];

            // Generate example-specific steps based on the operation
            const numbers = ex.question.match(/\d+/g) || [];
            if (numbers.length >= 2) {
                const n1 = parseInt(numbers[0]);
                const n2 = parseInt(numbers[1]);

                if (categoryKey === 'addition') {
                    if (shortcutKey === 'add9') {
                        steps.push(`Step 1: Start with ${n1}`);
                        steps.push(`Step 2: To add 9, add 10 instead: ${n1} + 10 = ${n1 + 10}`);
                        steps.push(`Step 3: Now subtract 1: ${n1 + 10} - 1 = ${ex.answer}`);
                        steps.push(`Step 4: Final answer: ${ex.answer}`);
                    } else {
                        steps.push(`Step 1: Write down the first number: ${n1}`);
                        steps.push(`Step 2: Add the second number: ${n1} + ${n2}`);
                        steps.push(`Step 3: Break down if needed: ${n1} + ${n2} = ${ex.answer}`);
                        steps.push(`Step 4: Final answer: ${ex.answer}`);
                    }
                } else if (categoryKey === 'subtraction') {
                    if (shortcutKey === 'sub9') {
                        steps.push(`Step 1: Start with ${n1}`);
                        steps.push(`Step 2: To subtract 9, subtract 10 instead: ${n1} - 10 = ${n1 - 10}`);
                        steps.push(`Step 3: Now add 1 back: ${n1 - 10} + 1 = ${ex.answer}`);
                        steps.push(`Step 4: Final answer: ${ex.answer}`);
                    } else {
                        steps.push(`Step 1: Start with ${n1}`);
                        steps.push(`Step 2: Subtract ${n2} from ${n1}`);
                        steps.push(`Step 3: Work through: ${n1} - ${n2} = ${ex.answer}`);
                        steps.push(`Step 4: Final answer: ${ex.answer}`);
                    }
                } else if (categoryKey === 'multiplication') {
                    const operation = ex.question;
                    steps.push(`Step 1: Set up the problem: ${operation}`);
                    steps.push(`Step 2: Look for patterns or shortcuts in the numbers`);
                    steps.push(`Step 3: Apply the Vedic multiplication technique for these specific numbers`);
                    steps.push(`Step 4: Calculate: ${n1} √ó ${n2} = ${ex.answer}`);
                } else if (categoryKey === 'division') {
                    steps.push(`Step 1: Set up the division: ${n1} √∑ ${n2}`);
                    steps.push(`Step 2: See how many times ${n2} fits into ${n1}`);
                    steps.push(`Step 3: Perform the division: ${n1} √∑ ${n2}`);
                    steps.push(`Step 4: Final answer: ${ex.answer}`);
                }
            }

            return steps;
        }

        function showLearnView(categoryKey, shortcutKey) {
            currentCategory = categoryKey;
            currentShortcut = shortcutKey;
            const shortcut = allShortcuts[categoryKey].shortcuts[shortcutKey];
            document.getElementById('learn-title').textContent = shortcut.title;
            document.getElementById('learn-explanation').textContent = shortcut.explanation;

            // Update video section based on shortcut
            const videoSection = document.getElementById('video-section');
            if (categoryKey === 'addition' && shortcutKey === 'add9') {
                // Show actual video link for add9
                videoSection.innerHTML = `
                    <h3 class="text-2xl font-bold text-white mb-4">üé• Video Tutorial</h3>
                    <div class="aspect-video bg-gray-800 rounded-lg overflow-hidden">
                        <iframe
                            src="https://sora.chatgpt.com/p/s_68f84388513881918282ccbaa3fe8f42"
                            class="w-full h-full border-0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen>
                        </iframe>
                    </div>
                    <p class="text-gray-400 text-sm mt-3 text-center">Watch how to add 9 quickly!</p>
                `;
            } else {
                // Show placeholder for other shortcuts
                videoSection.innerHTML = `
                    <h3 class="text-2xl font-bold text-white mb-4">üé• Video Tutorial</h3>
                    <div class="aspect-video bg-gray-800 rounded-lg flex items-center justify-center">
                        <div class="text-center">
                            <div class="text-6xl mb-4">üé¨</div>
                            <p class="text-gray-400 text-lg">Video tutorial coming soon!</p>
                            <p class="text-gray-500 text-sm mt-2">Will feature: Animated explanations + Silly narrator voices</p>
                        </div>
                    </div>
                `;
            }

            // Generate step-by-step breakdown
            const stepContainer = document.getElementById('step-by-step');
            stepContainer.innerHTML = '';
            const steps = generateStepByStep(categoryKey, shortcutKey);
            steps.forEach((step, index) => {
                stepContainer.innerHTML += `
                    <div class="bg-gray-800 border-l-4 border-red-400 p-4 rounded-r-lg">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 w-8 h-8 bg-red-400 rounded-full flex items-center justify-center text-black font-bold mr-3">
                                ${index + 1}
                            </div>
                            <div class="text-white text-lg">${step}</div>
                        </div>
                    </div>
                `;
            });

            // Generate subway word problems with interactive answers
            const wordProblemsContainer = document.getElementById('word-problems');
            wordProblemsContainer.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                const problem = generateSubwayWordProblem(categoryKey, shortcutKey);
                const problemId = `word-problem-${i}`;
                wordProblemsContainer.innerHTML += `
                    <div class="bg-gray-800 border border-yellow-400/40 p-5 rounded-lg" id="${problemId}">
                        <div class="flex items-start mb-3">
                            <span class="text-3xl mr-3">üöá</span>
                            <p class="text-white text-lg flex-1">${problem.question}</p>
                        </div>
                        <div class="ml-12 flex gap-3 items-center mb-3">
                            <input type="number"
                                   id="${problemId}-input"
                                   class="bg-gray-900 border-2 border-gray-600 rounded px-4 py-2 text-white text-lg w-32 focus:border-yellow-400 focus:outline-none"
                                   placeholder="Answer">
                            <button onclick="checkWordProblem('${problemId}', ${problem.answer}, '${problem.explanation}')"
                                    class="btn btn-primary text-sm px-4 py-2">
                                Check Answer
                            </button>
                        </div>
                        <div id="${problemId}-feedback" class="ml-12 hidden"></div>
                    </div>
                `;
            }

            // Generate practice examples (interactive)
            const examplesContainer = document.getElementById('learn-examples');
            examplesContainer.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                const ex = shortcut.generateQuestion();
                const practiceId = `practice-${i}`;
                examplesContainer.innerHTML += `
                    <div class="bg-gray-800 border border-red-400/30 p-5 rounded-lg" id="${practiceId}">
                        <div class="flex items-start mb-3">
                            <span class="font-semibold text-white text-xl flex-1">${ex.question} = ?</span>
                        </div>
                        <div class="flex gap-3 items-center mb-3">
                            <input type="number"
                                   id="${practiceId}-input"
                                   class="bg-gray-900 border-2 border-gray-600 rounded px-4 py-2 text-white text-lg w-32 focus:border-red-400 focus:outline-none"
                                   placeholder="Answer">
                            <button onclick="checkPractice('${practiceId}', ${ex.answer})"
                                    class="btn btn-primary text-sm px-4 py-2">
                                Show Answer
                            </button>
                        </div>
                        <div id="${practiceId}-feedback" class="hidden"></div>
                    </div>
                `;
            }

            switchView('learn-view');
        }


        // Generate varied subway-themed word problems for quiz
        function generateQuizWordProblem(categoryKey) {
            const wordProblems = {
                addition: [
                    {desc: "At 42nd St, {n1} passengers get on. At Times Square, {n2} more board. Total passengers?", calc: (n1, n2) => n1 + n2},
                    {desc: "There are {n1} subway trains on the 2 line and {n2} on the 1 line. Total trains?", calc: (n1, n2) => n1 + n2},
                    {desc: "A MetroCard has ${n1}. You add ${n2}. New balance?", calc: (n1, n2) => n1 + n2},
                    {desc: "The train has {n1} passengers. At the next stop, {n2} people board. How many now?", calc: (n1, n2) => n1 + n2},
                    {desc: "One subway car has {n1} seats and another has {n2} seats. Total seats?", calc: (n1, n2) => n1 + n2}
                ],
                subtraction: [
                    {desc: "The train starts with {n1} passengers. {n2} get off at 14th St. How many remain?", calc: (n1, n2) => n1 - n2},
                    {desc: "You have ${n1} on your MetroCard. A ride costs ${n2}. How much left?", calc: (n1, n2) => n1 - n2},
                    {desc: "It takes {n1} minutes to reach 110th St. After {n2} minutes, how much longer?", calc: (n1, n2) => n1 - n2},
                    {desc: "There were {n1} people waiting. {n2} got on the train. How many still waiting?", calc: (n1, n2) => n1 - n2},
                    {desc: "A subway car has {n1} wheels. {n2} need replacement. How many are good?", calc: (n1, n2) => n1 - n2}
                ],
                multiplication: [
                    {desc: "Each subway car holds {n1} passengers. There are {n2} cars. Total capacity?", calc: (n1, n2) => n1 * n2},
                    {desc: "A MetroCard costs ${n1}. You buy {n2} cards. Total cost?", calc: (n1, n2) => n1 * n2},
                    {desc: "Each train has {n1} wheels. With {n2} trains, how many wheels total?", calc: (n1, n2) => n1 * n2},
                    {desc: "The conductor works {n1} hours per day for {n2} days. Total hours?", calc: (n1, n2) => n1 * n2},
                    {desc: "{n1} passengers per station across {n2} stations. How many passengers?", calc: (n1, n2) => n1 * n2}
                ],
                division: [
                    {desc: "{n1} passengers split equally into {n2} subway cars. How many per car?", calc: (n1, n2) => n1 / n2},
                    {desc: "${n1} split among {n2} MetroCards equally. How much per card?", calc: (n1, n2) => n1 / n2},
                    {desc: "{n1} total stations divided into {n2} equal sections. Stations per section?", calc: (n1, n2) => n1 / n2},
                    {desc: "A {n1}-minute journey with {n2} equal stops. Minutes between stops?", calc: (n1, n2) => n1 / n2},
                    {desc: "{n1} subway tokens shared by {n2} people equally. Tokens per person?", calc: (n1, n2) => n1 / n2}
                ]
            };

            const problems = wordProblems[categoryKey] || wordProblems.addition;
            const problem = problems[Math.floor(Math.random() * problems.length)];

            let n1, n2;
            if (categoryKey === 'division') {
                n2 = Math.floor(Math.random() * 8) + 2;
                n1 = n2 * (Math.floor(Math.random() * 12) + 2);
            } else if (categoryKey === 'multiplication') {
                n1 = Math.floor(Math.random() * 12) + 2;
                n2 = Math.floor(Math.random() * 8) + 2;
            } else if (categoryKey === 'subtraction') {
                n1 = Math.floor(Math.random() * 50) + 20;
                n2 = Math.floor(Math.random() * n1);
            } else {
                n1 = Math.floor(Math.random() * 30) + 5;
                n2 = Math.floor(Math.random() * 25) + 5;
            }

            const question = problem.desc.replace('{n1}', n1).replace('{n2}', n2);
            const answer = problem.calc(n1, n2);

            return {question, answer};
        }

        // --- QUIZ LOGIC ---
        function startQuiz(categoryKey, shortcutKey) {
            currentCategory = categoryKey;
            currentShortcut = shortcutKey;
            currentQuestionIndex = 0;
            score = 0;
            quizQuestions = [];
            const shortcut = allShortcuts[categoryKey].shortcuts[shortcutKey];

            // Add 5 regular questions
            for (let i = 0; i < 5; i++) {
                quizQuestions.push(shortcut.generateQuestion());
            }

            // Add 5 varied subway word problems
            for (let i = 0; i < 5; i++) {
                quizQuestions.push(generateQuizWordProblem(categoryKey));
            }

            document.getElementById('quiz-title').textContent = `${shortcut.title} Quiz`;
            switchView('quiz-view');
            displayNextQuestion();
        }

        function displayNextQuestion() {
            if (currentQuestionIndex >= quizQuestions.length) {
                endQuiz();
                return;
            }

            const q = quizQuestions[currentQuestionIndex];
            document.getElementById('quiz-progress').textContent = `Question ${currentQuestionIndex + 1}/10`;
            document.getElementById('quiz-question').textContent = q.question;

            const answerInput = document.getElementById('quiz-answer');
            const submitBtn = document.getElementById('submit-answer-btn');

            // Re-enable input and button for next question
            answerInput.value = '';
            answerInput.disabled = false;
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            answerInput.focus();

            document.getElementById('feedback').textContent = '';
        }
        
        function handleSubmitAnswer() {
            if (currentQuestionIndex >= quizQuestions.length) return; // Prevent running after quiz ends

            const answerInput = document.getElementById('quiz-answer');
            const submitBtn = document.getElementById('submit-answer-btn');
            const feedbackEl = document.getElementById('feedback');

            // Prevent double-submission
            if (submitBtn.disabled) return;

            const userAnswer = parseInt(answerInput.value, 10);
            const correctAnswer = quizQuestions[currentQuestionIndex].answer;

            if (isNaN(userAnswer)) {
                feedbackEl.textContent = "‚ö†Ô∏è Please enter a number.";
                feedbackEl.className = "mt-4 h-8 text-xl font-bold text-yellow-400";
                return;
            }

            // Disable input and button during feedback period
            submitBtn.disabled = true;
            answerInput.disabled = true;
            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');

            if (userAnswer === correctAnswer) {
                score++;
                const coinsEarned = awardCoins(COINS_PER_CORRECT);
                awardDistance(DISTANCE_PER_CORRECT);

                // Add passengers when correct (1-3 passengers if there's room)
                const passengersToAdd = Math.floor(Math.random() * 3) + 1;
                const newPassengers = Math.min(gameStats.passengers + passengersToAdd, gameStats.maxPassengers);
                const actualAdded = newPassengers - gameStats.passengers;
                gameStats.passengers = newPassengers;

                feedbackEl.textContent = `‚úÖ CORRECT! +${coinsEarned} üí∞ +${DISTANCE_PER_CORRECT}m ${actualAdded > 0 ? '+' + actualAdded + 'üë•' : ''}`;
                feedbackEl.className = "mt-4 h-8 text-xl font-bold text-green-400";
                updateGameStats();
            } else {
                feedbackEl.textContent = `‚ùå Wrong! Answer: ${correctAnswer}`;
                feedbackEl.className = "mt-4 h-8 text-xl font-bold text-red-400";
            }

            currentQuestionIndex++;
            setTimeout(displayNextQuestion, 1200);
        }

        function endQuiz() {
            const progress = userProgress[currentCategory][currentShortcut];

            if (score >= 8) {
                progress.strength = Math.min(5, progress.strength + 1);
            } else if (score < 5 && progress.strength > 0) {
                 progress.strength = Math.max(0, progress.strength - 1);
            }
            progress.lastReviewed = new Date().toISOString();

            // Check for mastery (perfect score of 10/10)
            let masteryBonus = 0;
            const topicId = `${currentCategory}_${currentShortcut}`;
            if (score === 10 && !gameStats.masteredTopics.includes(topicId)) {
                gameStats.masteredTopics.push(topicId);
                masteryBonus = 1000 * gameStats.multiplier; // Extra 1000 coins for mastery!
                gameStats.coins += masteryBonus;
            }

            // Calculate bonuses
            const bonusCoins = score * 5 * gameStats.multiplier;
            const bonusDistance = score * 10;

            gameStats.coins += bonusCoins;
            gameStats.distance += bonusDistance;

            const distanceNeeded = DISTANCE_PER_LEVEL[gameStats.level - 1] || 5000;
            if (gameStats.distance >= distanceNeeded) {
                gameStats.distance -= distanceNeeded;
                levelUp();
            }

            saveProgress();
            showResultsModal(bonusCoins, bonusDistance, masteryBonus);
        }

        // --- SPACED REPETITION ---
        function startReviewSession() {
            let nextShortcut = null;
            let minStrength = 6;
            let oldestDate = new Date().toISOString();

            for (const catKey in userProgress) {
                for (const shortKey in userProgress[catKey]) {
                    const progress = userProgress[catKey][shortKey];
                    if (progress.strength >= 5) continue;

                    if (progress.strength < minStrength) {
                        minStrength = progress.strength;
                        oldestDate = progress.lastReviewed || '1970-01-01T00:00:00.000Z';
                        nextShortcut = { category: catKey, shortcut: shortKey };
                    } else if (progress.strength === minStrength) {
                        const currentLastReviewed = progress.lastReviewed || '1970-01-01T00:00:00.000Z';
                        if (currentLastReviewed < oldestDate) {
                            oldestDate = currentLastReviewed;
                            nextShortcut = { category: catKey, shortcut: shortKey };
                        }
                    }
                }
            }
            
            if (!nextShortcut) { // If all are mastered, pick a random one
                const categories = Object.keys(allShortcuts);
                const randomCategory = categories[Math.floor(Math.random() * categories.length)];
                const shortcuts = Object.keys(allShortcuts[randomCategory].shortcuts);
                const randomShortcut = shortcuts[Math.floor(Math.random() * shortcuts.length)];
                nextShortcut = { category: randomCategory, shortcut: randomShortcut };
            }

            showLearnView(nextShortcut.category, nextShortcut.shortcut);
        }
        
        // --- MODAL & UI ---
        function showResultsModal(bonusCoins, bonusDistance, masteryBonus = 0) {
            const modal = document.getElementById('results-modal');
            document.getElementById('results-score').textContent = `${score} / 10`;
            document.getElementById('coins-earned').textContent = bonusCoins;
            document.getElementById('xp-earned').textContent = bonusDistance + 'm';

            let message = "Keep pushing! üöá";
            if (score >= 8) message = "Great work! You're on track! üî•";
            if (score === 10 && masteryBonus > 0) message = `MASTERY ACHIEVED! üèÜ +${masteryBonus} BONUS COINS! (Total Mastered: ${gameStats.masteredTopics.length})`;
            else if (score === 10) message = "PERFECT! You're a math legend! üèÜ";
            document.getElementById('results-message').textContent = message;
            modal.classList.remove('hidden');
            updateGameStats();
        }

        function closeResultsModal() {
            document.getElementById('results-modal').classList.add('hidden');
            switchView('main-view');
            // If we were in a category, go back to that category grid
            if(currentCategory) {
                renderShortcutGrid(currentCategory);
            } else {
                renderCategories();
            }
        }
        
        // --- EVENT LISTENERS ---
        backToCategoriesBtn.addEventListener('click', renderCategories);
        document.getElementById('back-to-categories-btn-2').addEventListener('click', renderCategories);
        document.getElementById('back-to-main-btn').addEventListener('click', () => {
             switchView('main-view');
             renderShortcutGrid(currentCategory);
        });
        document.getElementById('start-quiz-btn').addEventListener('click', () => startQuiz(currentCategory, currentShortcut));
        document.getElementById('submit-answer-btn').addEventListener('click', handleSubmitAnswer);
        document.getElementById('quiz-answer').addEventListener('keyup', (e) => {
            if (e.key === 'Enter') handleSubmitAnswer();
        });
        document.getElementById('close-results-btn').addEventListener('click', closeResultsModal);
        document.getElementById('close-express-btn').addEventListener('click', () => {
            document.getElementById('express-modal').classList.add('hidden');
        });
        document.getElementById('close-levelup-btn').addEventListener('click', () => {
            document.getElementById('levelup-modal').classList.add('hidden');
            updateGameStats();
        });
        document.getElementById('close-store-btn').addEventListener('click', () => {
            document.getElementById('store-modal').classList.add('hidden');
        });
        document.getElementById('close-conductor-btn').addEventListener('click', () => {
            document.getElementById('conductor-modal').classList.add('hidden');
        });
        document.getElementById('close-subwaycar-btn').addEventListener('click', () => {
            document.getElementById('subwaycar-modal').classList.add('hidden');
        });
        reviewBtn.addEventListener('click', startReviewSession);

        // --- APP INITIALIZATION ---
        // authenticateUser(); // Firebase call commented out
        initializeLocalProgress(); // Use local progress instead
        updateGameStats(); // Initialize game stats display

    </script>
</body>
</html>

