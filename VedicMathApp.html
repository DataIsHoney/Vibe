<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vedic Math Fun - Learn Math Tricks!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Fredoka', 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .btn {
            display: inline-block;
            font-weight: 600;
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
            user-select: none;
            border: 1px solid transparent;
            padding: 0.75rem 1.5rem;
            font-size: 1.125rem;
            border-radius: 0.75rem;
            transition: all 0.15s ease-in-out;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 6px rgba(102, 126, 234, 0.3);
        }
        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 10px rgba(102, 126, 234, 0.4);
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #1f2937;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .btn-easy {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: #1f2937;
        }
        .btn-medium {
            background: linear-gradient(135deg, #ffd89b 0%, #ff9a76 100%);
            color: #1f2937;
        }
        .btn-hard {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: #1f2937;
        }
        .progress-bar-bg {
            background-color: #e5e7eb;
            border-radius: 9999px;
            height: 12px;
        }
        .progress-bar {
            background: linear-gradient(90deg, #4ade80 0%, #22c55e 100%);
            height: 100%;
            border-radius: 9999px;
            transition: width 0.3s ease-in-out;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 2.5rem;
            border-radius: 1.5rem;
            max-width: 90%;
            width: 500px;
        }
        .star {
            display: inline-block;
            font-size: 2rem;
            color: #fbbf24;
            animation: starPop 0.5s ease-in-out;
        }
        @keyframes starPop {
            0% { transform: scale(0); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        .celebration {
            animation: celebrate 0.6s ease-in-out;
        }
        @keyframes celebrate {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg) scale(1.1); }
            75% { transform: rotate(10deg) scale(1.1); }
        }
        .hint-box {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }
        .difficulty-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .badge-easy { background-color: #86efac; color: #166534; }
        .badge-medium { background-color: #fde047; color: #854d0e; }
        .badge-hard { background-color: #fca5a5; color: #991b1b; }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-100 via-pink-100 to-blue-100 min-h-screen">

    <div id="app" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-5xl font-bold text-purple-900 sm:text-6xl mb-2">Vedic Math Fun!</h1>
            <p class="text-2xl text-purple-700 mb-4">Learn Super Cool Math Tricks</p>
            <div id="stats-bar" class="flex justify-center gap-6 mt-4">
                <div class="bg-white rounded-lg px-6 py-3 shadow-md">
                    <div class="text-sm text-gray-600">Total Stars</div>
                    <div class="text-2xl font-bold text-yellow-500" id="total-stars">0</div>
                </div>
                <div class="bg-white rounded-lg px-6 py-3 shadow-md">
                    <div class="text-sm text-gray-600">Tricks Mastered</div>
                    <div class="text-2xl font-bold text-green-500" id="tricks-mastered">0</div>
                </div>
            </div>
        </header>

        <!-- Main View: Trick Selection -->
        <main id="main-view">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-purple-800 mb-4">Choose a Math Trick to Learn!</h2>
                <p class="text-lg text-gray-700">Click on any trick below to start learning</p>
            </div>

            <div id="trick-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Trick cards will be injected here -->
            </div>
        </main>

        <!-- Learn View: Trick Explanation -->
        <section id="learn-view" class="hidden">
            <div class="card p-8 max-w-4xl mx-auto">
                <button id="back-to-main-btn" class="btn btn-secondary mb-6">&larr; Back to Tricks</button>
                <h2 id="learn-title" class="text-4xl font-bold mb-4 text-purple-900"></h2>
                <div id="learn-difficulty-badge" class="mb-4"></div>
                <div class="bg-blue-50 border-l-4 border-blue-500 p-6 mb-6 rounded-lg">
                    <h3 class="text-xl font-semibold mb-2 text-blue-900">How it works:</h3>
                    <p id="learn-explanation" class="text-lg text-gray-700"></p>
                </div>
                <h3 class="text-2xl font-semibold mb-4 text-purple-800">Let's see some examples!</h3>
                <div id="learn-examples" class="space-y-3 text-lg mb-8"></div>
                <div class="text-center">
                    <p class="text-xl text-purple-700 mb-4">Ready to try it yourself?</p>
                    <div class="flex justify-center gap-4 flex-wrap">
                        <button class="btn btn-easy" onclick="startQuiz('easy')">Easy Practice</button>
                        <button class="btn btn-medium" onclick="startQuiz('medium')">Medium Practice</button>
                        <button class="btn btn-hard" onclick="startQuiz('hard')">Hard Challenge</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Quiz View -->
        <section id="quiz-view" class="hidden">
             <div class="card p-8 max-w-3xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="quiz-title" class="text-3xl font-bold text-purple-900">Practice Time!</h2>
                    <div id="quiz-difficulty-badge"></div>
                </div>
                <div class="flex justify-between items-center mb-4">
                    <div id="quiz-progress" class="text-lg font-medium text-gray-700"></div>
                    <div class="flex gap-1" id="quiz-stars"></div>
                </div>
                <div class="mb-8">
                    <div class="text-6xl font-bold text-center text-gray-800 py-12 bg-gradient-to-br from-purple-50 to-blue-50 rounded-xl" id="quiz-question"></div>
                </div>
                <div class="flex flex-col items-center">
                    <input
                        type="number"
                        id="quiz-answer"
                        class="text-center text-3xl p-4 border-4 border-purple-300 rounded-xl w-full max-w-md focus:ring-4 focus:ring-purple-400 focus:border-purple-500"
                        placeholder="Type your answer">
                    <div class="flex gap-4 mt-6 w-full max-w-md">
                        <button id="hint-btn" class="btn btn-secondary flex-1">Need a Hint?</button>
                        <button id="submit-answer-btn" class="btn btn-primary flex-1">Submit Answer</button>
                    </div>
                    <div id="hint-container" class="hidden w-full max-w-md mt-4"></div>
                    <p id="feedback" class="mt-4 h-8 text-xl font-bold"></p>
                </div>
             </div>
        </section>

    </div>

    <!-- Results Modal -->
    <div id="results-modal" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <div id="results-celebration" class="text-6xl mb-4"></div>
            <h2 class="text-4xl font-bold mb-4 text-purple-900">Great Job!</h2>
            <div id="results-stars" class="text-6xl mb-4"></div>
            <p class="text-6xl font-extrabold mb-2 text-purple-700" id="results-score"></p>
            <p class="text-xl text-gray-700 mb-6" id="results-message"></p>
            <div id="achievement-display" class="mb-6"></div>
            <button id="close-results-btn" class="btn btn-primary text-xl">Continue Learning!</button>
        </div>
    </div>

    <script>
        // ===== GLOBAL STATE =====
        let userProgress = {};
        let currentTrick = null;
        let currentDifficulty = 'easy';
        let quizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let hintsUsed = 0;
        let totalStars = 0;

        // ===== VEDIC MATH TRICKS DATA =====
        const vedicTricks = {
            doubling: {
                title: 'Doubling Magic',
                category: 'addition',
                explanation: 'When you add a number to itself, that\'s called doubling! It\'s the same as multiplying by 2. Practice your doubles and you\'ll be super fast!',
                icon: '✨',
                generateQuestion: (difficulty) => {
                    let n;
                    if (difficulty === 'easy') n = Math.floor(Math.random() * 10) + 1;
                    else if (difficulty === 'medium') n = Math.floor(Math.random() * 20) + 11;
                    else n = Math.floor(Math.random() * 40) + 21;
                    return {
                        question: `${n} + ${n}`,
                        answer: n * 2,
                        hint: `Think: What is ${n} times 2? Or count ${n} twice!`
                    };
                }
            },

            adding9: {
                title: 'Adding 9 Trick',
                category: 'addition',
                explanation: 'When you add 9 to a number, here\'s the trick: Add 10 instead (which is easy!), then subtract 1. For example: 25 + 9 = 25 + 10 - 1 = 35 - 1 = 34!',
                icon: '🎯',
                generateQuestion: (difficulty) => {
                    let n;
                    if (difficulty === 'easy') n = Math.floor(Math.random() * 20) + 10;
                    else if (difficulty === 'medium') n = Math.floor(Math.random() * 50) + 21;
                    else n = Math.floor(Math.random() * 100) + 51;
                    return {
                        question: `${n} + 9`,
                        answer: n + 9,
                        hint: `Add 10 to ${n} first to get ${n + 10}, then subtract 1!`
                    };
                }
            },

            make10: {
                title: 'Making 10',
                category: 'addition',
                explanation: 'Numbers that add up to 10 are special friends! Learn these pairs: 1+9, 2+8, 3+7, 4+6, 5+5. Knowing these helps you solve problems faster!',
                icon: '🔟',
                generateQuestion: (difficulty) => {
                    let n;
                    if (difficulty === 'easy') n = Math.floor(Math.random() * 5) + 1;
                    else if (difficulty === 'medium') n = Math.floor(Math.random() * 9) + 1;
                    else n = Math.floor(Math.random() * 19) + 1;

                    if (difficulty === 'hard') {
                        const tens = Math.floor(n / 10) * 10;
                        const ones = n % 10;
                        const needed = 10 - ones;
                        return {
                            question: `${n} + ${needed}`,
                            answer: n + needed,
                            hint: `${ones} + ${needed} makes 10, so ${n} + ${needed} = ${tens + 10}`
                        };
                    }

                    return {
                        question: `${n} + ? = 10`,
                        answer: 10 - n,
                        hint: `Count up from ${n} to 10. How many steps?`
                    };
                }
            },

            subtract9: {
                title: 'Subtracting 9 Trick',
                category: 'subtraction',
                explanation: 'When you subtract 9, here\'s the magic trick: Subtract 10 first (super easy!), then add 1 back. Example: 42 - 9 = 42 - 10 + 1 = 32 + 1 = 33!',
                icon: '🎪',
                generateQuestion: (difficulty) => {
                    let n;
                    if (difficulty === 'easy') n = Math.floor(Math.random() * 30) + 20;
                    else if (difficulty === 'medium') n = Math.floor(Math.random() * 50) + 31;
                    else n = Math.floor(Math.random() * 100) + 51;
                    return {
                        question: `${n} - 9`,
                        answer: n - 9,
                        hint: `Subtract 10 from ${n} to get ${n - 10}, then add 1!`
                    };
                }
            },

            countingUp: {
                title: 'Counting Up to Subtract',
                category: 'subtraction',
                explanation: 'Instead of subtracting, you can count UP! For 15 - 9, start at 9 and count up to 15: "10, 11, 12, 13, 14, 15" - that\'s 6 jumps! So 15 - 9 = 6!',
                icon: '⬆️',
                generateQuestion: (difficulty) => {
                    let n1, n2;
                    if (difficulty === 'easy') {
                        n2 = Math.floor(Math.random() * 8) + 2;
                        n1 = n2 + Math.floor(Math.random() * 5) + 2;
                    } else if (difficulty === 'medium') {
                        n2 = Math.floor(Math.random() * 20) + 10;
                        n1 = n2 + Math.floor(Math.random() * 10) + 5;
                    } else {
                        n2 = Math.floor(Math.random() * 50) + 20;
                        n1 = n2 + Math.floor(Math.random() * 20) + 10;
                    }
                    return {
                        question: `${n1} - ${n2}`,
                        answer: n1 - n2,
                        hint: `Start at ${n2} and count up to ${n1}. How many jumps?`
                    };
                }
            },

            times2: {
                title: 'Multiply by 2',
                category: 'multiplication',
                explanation: 'Multiplying by 2 is the same as doubling! Just add the number to itself. 7 × 2 = 7 + 7 = 14. Easy peasy!',
                icon: '×2️⃣',
                generateQuestion: (difficulty) => {
                    let n;
                    if (difficulty === 'easy') n = Math.floor(Math.random() * 10) + 1;
                    else if (difficulty === 'medium') n = Math.floor(Math.random() * 20) + 11;
                    else n = Math.floor(Math.random() * 40) + 21;
                    return {
                        question: `${n} × 2`,
                        answer: n * 2,
                        hint: `Just double ${n}! What is ${n} + ${n}?`
                    };
                }
            },

            times5: {
                title: 'Multiply by 5',
                category: 'multiplication',
                explanation: 'Here\'s a cool pattern: Numbers times 5 always end in 0 or 5! Trick: Multiply by 10, then cut in half. Example: 8 × 5 = (8 × 10) ÷ 2 = 80 ÷ 2 = 40!',
                icon: '✋',
                generateQuestion: (difficulty) => {
                    let n;
                    if (difficulty === 'easy') n = Math.floor(Math.random() * 10) + 1;
                    else if (difficulty === 'medium') n = Math.floor(Math.random() * 15) + 11;
                    else n = Math.floor(Math.random() * 20) + 21;
                    return {
                        question: `${n} × 5`,
                        answer: n * 5,
                        hint: `Try ${n} × 10 = ${n * 10}, then divide by 2!`
                    };
                }
            },

            times10: {
                title: 'Multiply by 10',
                category: 'multiplication',
                explanation: 'This is the EASIEST trick ever! To multiply any number by 10, just add a 0 at the end! 23 × 10 = 230. That\'s it!',
                icon: '🔟',
                generateQuestion: (difficulty) => {
                    let n;
                    if (difficulty === 'easy') n = Math.floor(Math.random() * 10) + 1;
                    else if (difficulty === 'medium') n = Math.floor(Math.random() * 50) + 11;
                    else n = Math.floor(Math.random() * 100) + 51;
                    return {
                        question: `${n} × 10`,
                        answer: n * 10,
                        hint: `Just add a zero to the end of ${n}!`
                    };
                }
            },

            times11: {
                title: 'Multiply by 11 (Magic!)',
                category: 'multiplication',
                explanation: 'For single digits: Just write the digit twice! 6 × 11 = 66. For two digits like 23: Add the two digits (2+3=5) and put it in the middle: 2_3 becomes 253!',
                icon: '🎩',
                generateQuestion: (difficulty) => {
                    let n;
                    if (difficulty === 'easy') {
                        n = Math.floor(Math.random() * 9) + 1;
                    } else if (difficulty === 'medium') {
                        const d1 = Math.floor(Math.random() * 5) + 1;
                        const d2 = Math.floor(Math.random() * (9 - d1)) + 1;
                        n = d1 * 10 + d2;
                    } else {
                        const d1 = Math.floor(Math.random() * 6) + 2;
                        const d2 = Math.floor(Math.random() * (9 - d1)) + 1;
                        n = d1 * 10 + d2;
                    }

                    if (n < 10) {
                        return {
                            question: `${n} × 11`,
                            answer: n * 11,
                            hint: `Write ${n} twice! ${n}${n}`
                        };
                    } else {
                        const d1 = Math.floor(n / 10);
                        const d2 = n % 10;
                        return {
                            question: `${n} × 11`,
                            answer: n * 11,
                            hint: `Add the digits: ${d1} + ${d2} = ${d1+d2}. Put it in middle: ${d1}${d1+d2}${d2}`
                        };
                    }
                }
            },

            times9fingers: {
                title: 'Times 9 Finger Trick',
                category: 'multiplication',
                explanation: 'Hold up all 10 fingers! To do 9 × 3, put down your 3rd finger. Count fingers on left (2) and right (7). Answer: 27! This works for 9 × 1 through 9 × 10!',
                icon: '🖐️',
                generateQuestion: (difficulty) => {
                    let n;
                    if (difficulty === 'easy') n = Math.floor(Math.random() * 5) + 2;
                    else if (difficulty === 'medium') n = Math.floor(Math.random() * 8) + 3;
                    else n = Math.floor(Math.random() * 9) + 2;
                    return {
                        question: `${n} × 9`,
                        answer: n * 9,
                        hint: `Put down finger #${n}. Count left and right fingers!`
                    };
                }
            },

            divideBy2: {
                title: 'Divide by 2 (Halving)',
                category: 'division',
                explanation: 'Dividing by 2 means cutting something in half! If you have 18 cookies and share with a friend, you each get 9. 18 ÷ 2 = 9!',
                icon: '➗',
                generateQuestion: (difficulty) => {
                    let n;
                    if (difficulty === 'easy') n = (Math.floor(Math.random() * 10) + 1) * 2;
                    else if (difficulty === 'medium') n = (Math.floor(Math.random() * 25) + 11) * 2;
                    else n = (Math.floor(Math.random() * 50) + 26) * 2;
                    return {
                        question: `${n} ÷ 2`,
                        answer: n / 2,
                        hint: `What is half of ${n}? Cut it in the middle!`
                    };
                }
            },

            divideBy10: {
                title: 'Divide by 10',
                category: 'division',
                explanation: 'This is super easy! To divide by 10, just remove the last 0! Example: 150 ÷ 10 = 15. Take off the zero!',
                icon: '🎯',
                generateQuestion: (difficulty) => {
                    let n;
                    if (difficulty === 'easy') n = (Math.floor(Math.random() * 9) + 1) * 10;
                    else if (difficulty === 'medium') n = (Math.floor(Math.random() * 50) + 10) * 10;
                    else n = (Math.floor(Math.random() * 100) + 51) * 10;
                    return {
                        question: `${n} ÷ 10`,
                        answer: n / 10,
                        hint: `Remove the zero from ${n}!`
                    };
                }
            }
        };

        // ===== INITIALIZATION =====
        function initializeApp() {
            loadProgress();
            renderTrickGrid();
            updateStats();
            setupEventListeners();
        }

        function loadProgress() {
            const saved = localStorage.getItem('vedicMathProgress');
            if (saved) {
                userProgress = JSON.parse(saved);
            } else {
                // Initialize progress
                for (const trickKey in vedicTricks) {
                    userProgress[trickKey] = {
                        easy: { completed: false, stars: 0, bestScore: 0 },
                        medium: { completed: false, stars: 0, bestScore: 0 },
                        hard: { completed: false, stars: 0, bestScore: 0 }
                    };
                }
                saveProgress();
            }
        }

        function saveProgress() {
            localStorage.setItem('vedicMathProgress', JSON.stringify(userProgress));
            updateStats();
        }

        function updateStats() {
            totalStars = 0;
            let masteredCount = 0;

            for (const trickKey in userProgress) {
                const progress = userProgress[trickKey];
                totalStars += progress.easy.stars + progress.medium.stars + progress.hard.stars;

                if (progress.easy.stars >= 3 && progress.medium.stars >= 3 && progress.hard.stars >= 3) {
                    masteredCount++;
                }
            }

            document.getElementById('total-stars').textContent = totalStars;
            document.getElementById('tricks-mastered').textContent = masteredCount;
        }

        // ===== VIEW RENDERING =====
        function renderTrickGrid() {
            const grid = document.getElementById('trick-grid');
            grid.innerHTML = '';

            Object.entries(vedicTricks).forEach(([key, trick]) => {
                const progress = userProgress[key];
                const totalStarsForTrick = progress.easy.stars + progress.medium.stars + progress.hard.stars;

                const card = document.createElement('div');
                card.className = 'card p-6 cursor-pointer hover:scale-105 transition-transform';
                card.innerHTML = `
                    <div class="text-5xl mb-3 text-center">${trick.icon}</div>
                    <h3 class="text-2xl font-bold mb-3 text-center text-purple-900">${trick.title}</h3>
                    <div class="flex justify-center gap-2 mb-3">
                        <span class="difficulty-badge badge-easy">Easy: ${progress.easy.stars}⭐</span>
                        <span class="difficulty-badge badge-medium">Med: ${progress.medium.stars}⭐</span>
                        <span class="difficulty-badge badge-hard">Hard: ${progress.hard.stars}⭐</span>
                    </div>
                    <div class="text-center text-xl font-bold text-yellow-500">
                        Total: ${totalStarsForTrick} ⭐
                    </div>
                `;
                card.addEventListener('click', () => showLearnView(key));
                grid.appendChild(card);
            });
        }

        function showLearnView(trickKey) {
            currentTrick = trickKey;
            const trick = vedicTricks[trickKey];

            document.getElementById('learn-title').textContent = trick.icon + ' ' + trick.title;
            document.getElementById('learn-explanation').textContent = trick.explanation;

            const examplesContainer = document.getElementById('learn-examples');
            examplesContainer.innerHTML = '';

            // Generate examples for each difficulty
            ['easy', 'medium', 'hard'].forEach(diff => {
                const example = trick.generateQuestion(diff);
                const badge = diff === 'easy' ? 'badge-easy' : diff === 'medium' ? 'badge-medium' : 'badge-hard';
                examplesContainer.innerHTML += `
                    <div class="bg-gradient-to-r from-purple-50 to-blue-50 p-4 rounded-lg border-2 border-purple-200">
                        <span class="difficulty-badge ${badge} mb-2 inline-block">${diff.charAt(0).toUpperCase() + diff.slice(1)}</span>
                        <div class="text-2xl font-bold text-gray-800">
                            ${example.question} = <span class="text-purple-600">${example.answer}</span>
                        </div>
                    </div>
                `;
            });

            switchView('learn-view');
        }

        // ===== QUIZ LOGIC =====
        window.startQuiz = function(difficulty) {
            currentDifficulty = difficulty;
            currentQuestionIndex = 0;
            score = 0;
            hintsUsed = 0;
            quizQuestions = [];

            const trick = vedicTricks[currentTrick];
            for (let i = 0; i < 10; i++) {
                quizQuestions.push(trick.generateQuestion(difficulty));
            }

            const badgeClass = difficulty === 'easy' ? 'badge-easy' : difficulty === 'medium' ? 'badge-medium' : 'badge-hard';
            document.getElementById('quiz-title').textContent = trick.icon + ' ' + trick.title;
            document.getElementById('quiz-difficulty-badge').innerHTML = `
                <span class="difficulty-badge ${badgeClass}">${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)} Level</span>
            `;

            switchView('quiz-view');
            displayNextQuestion();
        };

        function displayNextQuestion() {
            if (currentQuestionIndex >= quizQuestions.length) {
                endQuiz();
                return;
            }

            const q = quizQuestions[currentQuestionIndex];
            document.getElementById('quiz-progress').textContent = `Question ${currentQuestionIndex + 1}/10`;
            document.getElementById('quiz-question').textContent = q.question + ' = ?';

            // Update star display
            const starsContainer = document.getElementById('quiz-stars');
            starsContainer.innerHTML = '';
            for (let i = 0; i < currentQuestionIndex; i++) {
                starsContainer.innerHTML += '<span class="star">⭐</span>';
            }

            const answerInput = document.getElementById('quiz-answer');
            answerInput.value = '';
            answerInput.focus();

            document.getElementById('feedback').textContent = '';
            document.getElementById('hint-container').classList.add('hidden');
            document.getElementById('hint-container').innerHTML = '';
            document.getElementById('hint-btn').disabled = false;
        }

        function showHint() {
            const q = quizQuestions[currentQuestionIndex];
            const hintContainer = document.getElementById('hint-container');
            hintContainer.className = 'hint-box w-full max-w-md mt-4';
            hintContainer.innerHTML = `
                <div class="font-semibold text-lg mb-2">Hint:</div>
                <div class="text-gray-800">${q.hint}</div>
            `;
            document.getElementById('hint-btn').disabled = true;
            hintsUsed++;
        }

        function handleSubmitAnswer() {
            if (currentQuestionIndex >= quizQuestions.length) return;

            const feedbackEl = document.getElementById('feedback');
            const userAnswer = parseInt(document.getElementById('quiz-answer').value, 10);
            const correctAnswer = quizQuestions[currentQuestionIndex].answer;

            if (isNaN(userAnswer)) {
                feedbackEl.textContent = "Please enter a number!";
                feedbackEl.className = "mt-4 h-8 text-xl font-bold text-yellow-600";
                return;
            }

            if (userAnswer === correctAnswer) {
                score++;
                feedbackEl.textContent = "Correct! Great job!";
                feedbackEl.className = "mt-4 h-8 text-xl font-bold text-green-600 celebration";

                // Add star animation
                const starsContainer = document.getElementById('quiz-stars');
                starsContainer.innerHTML += '<span class="star">⭐</span>';
            } else {
                feedbackEl.textContent = `Not quite. The answer is ${correctAnswer}`;
                feedbackEl.className = "mt-4 h-8 text-xl font-bold text-red-600";
            }

            currentQuestionIndex++;
            setTimeout(displayNextQuestion, 1800);
        }

        function endQuiz() {
            const progress = userProgress[currentTrick][currentDifficulty];

            // Calculate stars earned (0-3 based on score)
            let starsEarned = 0;
            if (score >= 9) starsEarned = 3;
            else if (score >= 7) starsEarned = 2;
            else if (score >= 5) starsEarned = 1;

            // Penalty for using hints
            if (hintsUsed > 3) starsEarned = Math.max(0, starsEarned - 1);

            // Update progress
            if (score > progress.bestScore) {
                progress.bestScore = score;
            }
            if (starsEarned > progress.stars) {
                progress.stars = starsEarned;
            }
            if (score >= 5) {
                progress.completed = true;
            }

            saveProgress();
            showResultsModal(starsEarned);
        }

        function showResultsModal(starsEarned) {
            const modal = document.getElementById('results-modal');

            // Celebration emoji based on score
            let celebration = '';
            if (score === 10) celebration = '🎉🏆🎉';
            else if (score >= 8) celebration = '🎊✨🎊';
            else if (score >= 5) celebration = '👏😊👏';
            else celebration = '💪🌟💪';

            document.getElementById('results-celebration').textContent = celebration;
            document.getElementById('results-score').textContent = `${score} / 10`;

            // Stars display
            const starsDisplay = document.getElementById('results-stars');
            starsDisplay.innerHTML = '';
            for (let i = 0; i < starsEarned; i++) {
                starsDisplay.innerHTML += '<span class="star">⭐</span>';
            }

            // Encouraging message
            let message = '';
            if (score === 10) message = 'PERFECT! You\'re a math superstar!';
            else if (score >= 8) message = 'Awesome! You\'re really getting it!';
            else if (score >= 5) message = 'Good job! Keep practicing!';
            else message = 'Nice try! Practice makes perfect!';

            if (hintsUsed > 0) {
                message += ` (You used ${hintsUsed} hint${hintsUsed > 1 ? 's' : ''})`;
            }

            document.getElementById('results-message').textContent = message;

            // Achievement display
            const achievementDisplay = document.getElementById('achievement-display');
            if (score === 10 && hintsUsed === 0) {
                achievementDisplay.innerHTML = `
                    <div class="bg-yellow-100 border-2 border-yellow-400 rounded-lg p-4 text-xl font-bold text-yellow-800">
                        Achievement Unlocked: Perfect Score!
                    </div>
                `;
            } else {
                achievementDisplay.innerHTML = '';
            }

            modal.classList.remove('hidden');
        }

        function closeResultsModal() {
            document.getElementById('results-modal').classList.add('hidden');
            switchView('main-view');
            renderTrickGrid();
        }

        function switchView(viewId) {
            ['main-view', 'learn-view', 'quiz-view'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');
        }

        // ===== EVENT LISTENERS =====
        function setupEventListeners() {
            document.getElementById('back-to-main-btn').addEventListener('click', () => {
                switchView('main-view');
            });

            document.getElementById('submit-answer-btn').addEventListener('click', handleSubmitAnswer);

            document.getElementById('quiz-answer').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') handleSubmitAnswer();
            });

            document.getElementById('hint-btn').addEventListener('click', showHint);
            document.getElementById('close-results-btn').addEventListener('click', closeResultsModal);
        }

        // ===== START APP =====
        initializeApp();
    </script>
</body>
</html>
